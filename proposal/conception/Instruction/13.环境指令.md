# 环境指令

脚本的运行处在一个逐层嵌套的环境：`系统域 > 交易域 > 校验域 > 脚本域 > 块域`，其中前者是后者的父域。

1. **系统域**。节点的运行时环境。包含节点能提供的一些系统级信息。
2. **交易域**。一笔交易可包含多个输入和输出，以及输入的来源输出部分。
3. **校验域**。当前输出的校验环境，包含 `GOTO` 跳转引入的脚本的验证。
4. **脚本域**。脚本的环境。包含顶层脚本和 `GOTO` 跳转或 `SCRIPT` 引入的子脚本等。
5. **块  域**。即语法块的局部域，包含顶层和嵌套子块。局部域无法互访。

该类指令大多不需要实参，除了设置脚本全局变量的 `SETVAR`。

> **附注：**
> 数据栈和实参空间属于脚本域。脚本域可以嵌套，因此子脚本也有自己的数据栈和实参区。


## 定义

指令码区间：`[128-137]`，10个。

```go
码值    指令字      说明
-----------------------------------------------------------
128     ENV(1){}    环境变量取值
        // 附参：目标标识。
        // 返回值：目标条目的值。
        // 提示：
        // 以下定义的名称并不全面，详情请参考具体实现。
        //
        // 系统域：
        // 即整个区块链环境。
        // - Timestamp   当前实际时间戳（秒数）
        // - ChainHeight 区块链当前高度（按交易时间戳算）
        // - BlockTime   当前区块的时间戳（同上推算，即理想块时间戳）
        //
        // 交易域：
        // 脚本所在的交易。
        // - Height     交易所在区块的高度
        // - TxTime     交易时间戳
        // - TxID       交易ID
        // 例：
        // ENV{Height}  获取脚本所在区块的高度
        // 注意：
        // 当脚本作为输入项被引用时，针对的是源交易所在区块。
        //
        // 校验域：
        // 特定于当前脚本。
        // - InGoto     是否在 GOTO 的脚本中
        // - InEmbed    是否在 EMBED 的脚本中
        // - InScript   是否在 SCRIPT 引入的脚本中
        // - InCode     是否在 CODE 定义的脚本中
        // - Gotos      当前 GOTO 跳转计数
        // - Embeds     当前 Embed 嵌入计数
        // - Source0    主脚本源码（不含解锁部分）
        // - Source1    第1个外部引入（SCRIPT|EMBED|GOTO）的脚本源码
        // - ...        第2~8个……
        // - Source9    第9个外部引入的脚本源码
        // - Sources    截止当前，引入的外部脚本数量（<10）
        // 注：
        // 外部脚本及其计数按运行时计算（与执行流相关）。
        // SourceN 系列变量主要为方便模式验证。

129     IN(1){}     输入项取值（校验域）
        // 对于脚本来说，即未来被花费时输入部分的信息。
        // 附参:目标标识。
        // 返回值：目标条目的值。
        // 条目：
        // - Index      当前输入在输入集内的序位
        // - Amount     当前输入的币金数量（同 INOUT:Amount）
        // - Account    当前输入的账户（公钥哈希，即 INOUT:Receiver）
        // - Remarks    当前输入的付款附言
        // - Sigs       当前输入已签名数量（>= 0）
        // - CanSigs    当前输入能够签名的数量（多重签名时）
        // - SigType    当前输入的签名类型
        // - Script     当前输入脚本（含解锁部分）
        // - Source     当前输入脚本（不含解锁部分）

130     OUT(~,1){}  输出项取值（交易域）
        // 针对当前待验证交易的输出集。
        // 即未来花费者的转账目标部分，可用于定向约束（如遗嘱，有预定的规则）。
        // 附参1：输出项序位（起始值0）。
        // 附参2：目标标识。
        // 返回值：目标条目的值。
        // 条目：
        // - Amount         币金数量
        // - Receiver       接收者
        // - Remarks        付款附言
        // - Creator        凭信/存证创建者
        // - Title          凭信/存证标题
        // - Description    凭信描述
        // - Content        存证内容
        // - Count          凭信转移计数
        // - Attachment     附件ID
        // - Source         输出脚本（字节序列）
        // 例：
        // OUT[0]{Amount}   当前交易首项输出的币金数量

131     INOUT(~,1){}    源输出项取值（交易域）
        // 输入项来源交易的输出集（兄弟条目）成员取值。
        // 附参1：输出项序位（起始值0）。
        // 附参2：目标标识。
        // 返回值：目标条目的值。
        // 条目：
        // - ....       同前 OUT 部分
        // - Timestamp  源交易的创建时间戳
        //
        // 注记：
        // 逻辑上 IN 即是 INOUT 中的当前项，但这里仅针对源码逻辑。
        // 注意这是一条消耗资源的指令，
        // 因为这需要系统载入输入源的兄弟输出项集。

132     XFROM(1){}  获取源脚本信息（交易域）
        // 外部脚本对跳转来源交易的信息检索（GOTO, EMBED）。
        // 附参：目标标识。
        // 返回值：目标条目的值。
        // 条目：
        // - InSize     源交易输入集大小（项数）
        // - InAmount   源交易输入总金额
        // - OutSize    源交易输出集大小（项数）
        // - OutAmount  源交易输出总金额
        // - Timestamp  源交易的创建时间戳
        // - Amount     源脚本关联币金数量
        // - Account    源脚本关联账户（公钥哈希）
        // - PayType    源脚本关联的类型（币金|凭信|存证）
        // - Source     源脚本指令序列（从开头到跳转点）
        // 注：
        // 来源交易指花费输出时，当前正在验证的交易，
        // 而非输入项源脚本所在的交易。

133     VAR(1)      全局变量取值（脚本域）
        // 附参：目标变量位置 [0-255]。
        // 返回值：目标置位的值，单值。
        // 注意：
        // 与局部域不同，此为变量逻辑，可被赋值覆盖。
        // 例：
        // @VAR[0]  取全局变量集0号位置的值，添加到实参区。
        // VAR[10]  取全局变量集10号位置的值入栈。
        // 提示：
        // 本指令属于脚本域，不跨GOTO。
        // 但EMBED嵌入的脚本共享相同环境，因此会相互影响。

134     SETVAR(1)   全局变量赋值（脚本域）
        // 对当前脚本域的全局变量区设置值，配合 VAR 使用。
        // 附参：变量位置 [0-255]。
        // 实参：任意类型，单值。
        // 返回值：无。
        // 例：
        // {123} SETVAR[1]      将栈顶的值 123 存入全局变量域的1号位置。
        // {1.5} SETVAR[255]    将浮点数 1.5 存入全局变量域的255号位置。
        // $VAR[1]              读取上面存入的 123 添加到当前局部域。

135     SOURCE(1)   源脚本序列提取（脚本域）
        // 获取源脚本的指令码序列，受指令所在层级限制。
        // 附参：取值标识。
        // 返回值：字节序列（副本）。
        // 注意，返回的是字节序列而非Script类型。
        // 标识：
        // > 0  当前块完整代码（含 SOURCE）。
        // > 1  当前块前阶已执行代码段（含 SOURCE）。
        // > 11 同上，但不含 SOURCE。
        // > 2  当前块前阶已执行代码段，从最近的 NULL 点开始（不含 NULL，含 SOURCE）。
        // > 12 同上，但不含 SOURCE。
        // > -1 当前块后阶未执行代码段，直到块末尾。注：已不含 SOURCE，下同。
        // > -2 当前块后阶未执行代码段，直到最近的 NULL 点（不含 NULL）。
        // 提示：
        // NULL 点由系统指令 SYS_NULL 标记。
        // 只有在顶层的 SOURCE 才能获取到完整的脚本（含解锁段）。
        //
        // 记忆：
        // 可以把 11/12 中前置的1视为增强（移除 SOURCE）。

136     MULSIG(1)   多重签名序位确认（校验域）
        // 检查目标序位的账户是否有签名。
        // 附参：目标序位。
        // 返回值：布尔值。
        // 序位指多重签名公钥哈希清单中的序位，从0开始。
        // 仅用于多重签名的输入项。
        // 例：
        // MULSIG[1] PASS   // 如果多重签名中的第2位签了名，通过。
        // 例：
        // 确认3个参与者中至少有2个签名。
        // MULSIG[0] MULSIG[1] MULSIG[2] SHIFT[3] SOME[2] PASS
        //
        // 提示：
        // 属于校验域，在GOTO到的目标脚本中也可见。

137     （未用）
```


## 实现参考

重要的环境信息应当对中间件开放，让它们可以感知系统状态，获取确定的值。

如：`ENV{}`、`IN{}`、`OUT{}`、`INOUT{}` 中部分的成员值信息。
