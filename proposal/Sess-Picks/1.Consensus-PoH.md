# Consensus: Proof of Historical (PoH)（共识：历史证明）

## 1. Overview（概述）

Evidcoin 采用**历史证明（Proof of Historical, PoH）** 共识机制，以已确认交易的 ID 作为铸造权竞争的基础因子。

核心特性：
- **节能**：无需哈希碰撞运算，不消耗大量电力。
- **去中心化**：与财富无关，无"富者越富"效应，所有合法交易 ID 平等参与。
- **确定性出块**：固定 6 分钟出块间隔，时间戳由创世块时间和区块高度严格计算。
- **历史不可篡改**：交易 ID 为历史数据，无法更改；结合 UTXO 指纹的双路保护，实现对区块链历史的强约束。


## 2. Minting Credential（铸凭机制）

### 2.1 Eligible Transactions（铸凭交易）

参与铸造竞争的交易（铸凭交易）须满足：

- **区块范围**：位于 `[-80000, -25]` 号区块内（约 11 个月的历史窗口）。
- **淘汰机制**：超出 80000 个区块的历史交易失去资格，迫使参与者持续创建新交易。
- **竞争者身份**：铸凭交易首笔输入的源地址（已花费的账户），而非接收者，以避免冷挖矿需求。

### 2.2 Minting Hash（铸凭哈希计算）

铸凭哈希由三步运算产生，签名步骤确保攻击者无法预知结果：

```
hashData = Hash( TxID + ReferenceBlock.MintHash + Block[-24].UTXOFingerprint + CurrentBlockTimestamp )
signData = Sign( hashData )        // 用铸凭者私钥签名（结果私有）
hashMint = Hash( signData )        // 最终铸凭哈希
```

评选规则：铸凭哈希的字节序列值，小者胜出。

### 2.3 Anti-Shaping Design（防哈希塑造设计）

为抵御「哈希塑造」攻击（通过注入随机数据操纵哈希结果），参与因子的选择遵循不可塑或高成本原则：

| 因子 | 不可塑性来源 |
|------|-------------|
| 铸凭交易 ID | 历史数据，不可更改 |
| 评参区块铸凭哈希 | 该铸造者由市场竞争产生，无法控制 |
| `-24` 号区块 UTXO 指纹 | 塑造需大量交易费（成本高昂），且评参区块铸造者未知 |
| 当前区块时间戳 | 固定间隔计算，无自由度 |

### 2.4 Reference Block（评参区块）

- 位置：链末端 `-9` 号区块。
- 作用：提供铸凭哈希计算的动态参数（评参区块自身的铸凭哈希）。
- 特性：铸造候选者最多可提前 8 个区块时段得知对比目标，为全网预选提供充足沟通时间。


## 3. Best Pool（择优池）

### 3.1 Structure（结构）

- 容量：**20** 名候选者。
- 排序：按铸凭哈希字节序列从小到大排列（值小者优）。
- 每个评参区块对应一个独立的择优池。

### 3.2 Credential Content（择优凭证）

铸造候选者的证明包含：
- 交易定位：年度 + 交易 ID。
- 铸造者：首笔输入接收者的公钥。
- 签名数据：铸凭哈希计算过程中的签名（`signData`）。

最终存储于区块 Coinbase 交易中。

### 3.3 Synchronization（择优池同步）

同步分三个阶段：

| 阶段 | 时段 | 说明 |
|------|------|------|
| 广播收集 | 新区块创建后至 `-7` 号前（6 个区块时段） | 各节点广播、收集、优选铸凭交易 |
| 同步优化 | `-7` 号至 `-9` 号区块（2 个区块时段） | 择优池冻结更新，后 15 名成员有权发起同步 |
| 抵达结束 | 成为 `-9` 号评参区块 | 候选者确定 |

同步权限：择优池中排名第 6~20 位的成员（后 15 名）有权发起同步，每个授权节点仅有一次同步权力。此设计基于利益无关性考虑。

同步机制：
- 授权节点签名并广播自己的**同步池**。
- 接收方创建**合并池**，验证并合并同步池数据。
- 最终合并池替换本地择优池。


## 4. Block Minting（区块铸造）

### 4.1 Timing（时序）

- 首个区块（择优池冠军）在标准出块时间点延后 **30 秒** 发布。
- 后续候选者按排名顺序，间隔 **15 秒** 依次发布（冗余安全机制）。
- 候选者收到排名更优者的合法区块后，停止发布。

### 4.2 Block Competition（区块竞争）

同高度多区块的竞争规则：
- **同一铸造者多签**：交易费收益最低的区块有效（低收益原则）。
- **候选者冗余区块**：仅当候选区块的币权销毁量 ≥ 主区块的 3 倍时，候选区块胜出（交易量约束）。

### 4.3 Block Publication（区块发布）

分三段渐进发布：
1. **区块证明**：Coinbase 交易 + 哈希验证序列 + 铸造者签名 + 区块头。
2. **区块概要**：全部交易 ID 序列（截取前 16 字节优化传输）。
3. **交易同步**：仅补足各节点缺失的少量交易。


## 5. Fork Resolution（分叉处理）

### 5.1 Fork Competition（分叉竞争）

- 分叉须成长至 **25 个区块**（150 分钟）后评比。
- 逐区块平级对比各自 Coinbase 中的铸凭哈希，先胜出过半（≥13）者赢。
- 超出 25 区块的隐秘分叉视为另一条独立链，不予理会。

### 5.2 Absolute Safety（绝对安全性）

经 25 个区块确认的交易具有终局性——不会被任何分叉影响。新铸造的币金同样需要 25 个区块确认后方可花费。

### 5.3 Transaction Recovery（交易回收）

分叉竞争完成后，失败链上的交易可合并到主链，因为两条链通常仅有少量差异交易。


## 6. Bootstrap（初始引导阶段）

### 6.1 Initial Segment Rules（初段规则）

- 区块高度 < 9 时：评参区块取创世块。
- 区块高度 < 25 时：所有合法交易 ID 均可参与铸造竞争。

### 6.2 Hundred-Day Expansion（百日扩张方案）

| 阶段 | 区块范围 | 天数 | 说明 |
|------|---------|------|------|
| 私钥扩张 | 1~10 | <1 | 创建收益地址 |
| 币金积累 | 11~7200 | 30 | 观察期，保留停止权 |
| 抽奖扩张 | 7201~24000 | ~70 | 社区推广，分发币金 |
| 正式运营 | 24001+ | 101+ | 接受公共服务，启动外部奖励 |

初期约束：每交易输出项数量不超过输入数量的 2 倍。


## 7. Other Protocols（其它端点约定）

### 7.1 Protocol vs Convention（协议与共约）

- **协议**：强制遵守，违反即非法。如交易过期规则。
- **共约**：建议遵守，无强制力。如最低交易费。

### 7.2 Key Rules（关键规则）

| 规则 | 类型 | 说明 |
|------|------|------|
| 交易过期 | 协议 | 超过 240 个区块（24 小时）未收录的交易失效 |
| 最低交易费 | 共约 | 每 6000 个区块统计平均值的 1/4 |
| 零确认警告 | 共约 | 发现双花交易时向用户发送警告 |
| 全网通告 | 机制 | 唯一中心化机制，仅限签名文本消息 |


## 8. Design Parameters Summary（设计参数汇总）

```
出块间隔            6 分钟
每年区块数          87661
铸凭交易有效范围    [-80000, -25] 号区块（约 11 个月）
择优池容量          20 名候选者
同步授权成员        后 15 名（第 6~20 位）
首区块发布延迟      30 秒
候选者发布间隔      15 秒
分叉评比长度        25 个区块
新币确认数          25 个区块
交易过期            240 个区块（24 小时）
最低交易费统计周期  6000 个区块（25 天）
```

