# Transaction（交易结构设计）

## 1. Overview（概述）

交易是 Evidcoin 中信用表达和转移的封装单元。一笔交易由输入项集合和输出项集合构成，通过交易头摘要生成交易 ID。

设计目标：
- 便于检索和验证（哈希校验树）。
- 支持多种信元类型（币金、凭信、存证）的混合交易。
- 签名数据与交易 ID 解耦，支持后期丢弃。


## 2. Transaction Header（交易头）

```go
TxHeader {
    Version    int       // 版本号
    Timestamp  int64     // 交易时间戳（Unix 纳秒）
    HashBody   Hash512   // 数据体哈希
}

TxID = Hash512( TxHeader )
HashBody = Hash512( InputHash + OutputHash )
```

- 交易 ID 即交易头的 SHA-512 哈希。
- 交易体哈希由输入集哈希和输出集哈希合并计算。
- **签名数据不参与交易 ID 计算**。


## 3. Inputs（输入项）

### 3.1 Structure（结构）

每个输入项引用另一笔交易的未花费输出（UTXO）：

| 字段 | 长度 | 说明 |
|------|------|------|
| `Year` | varint | 交易所在年度 |
| `TxID` | 64 字节（首领）/ 20 字节（其余） | 交易 ID 引用 |
| `OutIndex` | varint | 来源输出项序位 |
| `TransferIndex` | varint | 凭信转出序位（凭信专用） |

- **首领输入**：首笔输入使用完整 64 字节交易 ID，便于铸凭交易属主检索和验证。
- **其余输入**：使用 20 字节前段片段，降低数据量。从 UTXO 集检索（UTXO 集由指纹保证可靠，仅涉及重名问题）。

约束：不支持未确认交易的输出作为输入（即不支持链式未确认支付）。

### 3.2 Input Hash Tree（输入哈希校验树）

```go
InputHash = Hash512( LeadHash + RestHash )

LeadHash = Hash512( Year + TxID[64] + OutIndex )
RestHash = Hash512( Concat( RestInputs ) )
```

首领输入单列计算，便于快速定位和验证铸凭属主。

### 3.3 Validation（合法性验证）

解锁脚本 + 锁定脚本 → 执行成功即通过。

首领校验（快速通道）：仅验证首笔输入，用于交易快速广播。约束：
- 首笔输入必须是币金，且为全部币金输入中币权最大者。
- 最终验证失败的首领输入进入黑名单（冻结 24 小时）。


## 4. Outputs（输出项）

### 4.1 Structure（结构）

```go
Output {
    Serial      int       // 输出序位（从 0 开始）
    Config      byte      // 1 字节配置
    Amount      int64     // 币金数量（币金类型）
    Address     [48]byte  // 接收地址
    LockScript  []byte    // 锁定脚本
    ...                   // 信元类型相关字段
}
```

### 4.2 Config Byte（输出配置字节）

```
Bit 7: 自定义类 — 置位时余下 7 位为类 ID 长度计数
Bit 6: 包含附件 — 如自定义类置位则变义
Bit 5: 销毁标记 — 币金/凭信销毁
Bit 4: （未用）
Bit [0-3]: 类型值
    0: 预留
    1: 币金 — 可作为输入源
    2: 凭信 — 可作为输入源
    3: 存证 — 不能作为输入源
    4: 介管 — 接收脚本跳转/嵌入的中间脚本
```

### 4.3 Intermediary Script（介管脚本）

类型为 4 的输出项。不可作为交易输入，仅通过 `GOTO` 或 `EMBED` 在脚本中引用。用于插入监管或审计逻辑。

### 4.4 Custom Class（自定义类）

用户创建的专属私有脚本类型。包含私有扩展指令，无法被公共客户端理解，不进入 UTXO。最长 127 字节的类 ID 用于专属客户端识别。

### 4.5 Output Hash Tree（输出哈希校验树）

```go
OutputHash = Hash512( BinaryTree<Outputs> )
```

各输出项作为叶子节点，按二元树结构组织哈希校验树。


## 5. Coinbase Transaction（铸币交易）

特殊交易，无输入源。始终位于区块交易序列的首位（[0]）。

包含字段：
- **区块高度**：明确位置。
- **择优凭证**：铸造者资格证明。
- **收益总额**：铸币 + 交易费 × 50% + 兑奖截留。
- **收益分成**：铸造者/铸凭者/Depots/Blockqs/STUN 各自的收益地址和金额。
- **兑奖槽**：对前段 48 区块的服务奖励确认标记（144 位 = 18 字节）。
- **自由数据**：< 256 字节，供铸造者灵活使用。


## 6. UTXO Model（UTXO 模型）

### 6.1 UTXO Set（UTXO 集合）

- 所有已确认交易的未花费输出构成 UTXO 集。
- 未确认交易的输出**不属于** UTXO。
- 当前 UTXO 集确定于上一个区块。

### 6.2 UTXO Fingerprint（UTXO 指纹）

四层分级哈希结构：

```
年度 → 交易 → 输出项 → 哈希叶子
```

- 顶层按交易时间戳对应的 UTC 年度分级。
- 减少每次输出变化带来的重新计算量。
- 双重角色：验证 UTXO 集完整性 + UTXO 缓存的组织格式。

### 6.3 Chain Constraint（链式约束）

UTXO 指纹与区块 ID 形成双路保护：
- 当前区块的 UTXO 指纹从当前 UTXO 集（上一区块的结果集）计算。
- 可逆向推导验证任意历史位置的 UTXO 集合法性。


## 7. Storage & Retrieval（存储与检索）

交易数据完整存储由外部公共服务（Blockqs/Depots）提供：

- **数据部分**：按交易年度 + 交易 ID 索引，存储完整交易数据。
- **验证部分**：按区块年度 + 高度索引，存储交易 ID 清单和哈希校验树验证路径。


## 8. Design Parameters Summary（设计参数汇总）

```
交易 ID 哈希算法        SHA-512（64 字节）
公钥哈希算法            SHA3-384（48 字节）
首领输入 TxID 引用      64 字节（完整）
其余输入 TxID 引用      20 字节（前段片段）
单笔交易最大尺寸        < 8KB（不含解锁部分）
输出项最大数量          < 1024
交易过期时限            240 个区块（24 小时）
Coinbase 自由数据       < 256 字节
```

