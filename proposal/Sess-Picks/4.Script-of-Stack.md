# Script System（栈式脚本系统）

## 1. Overview（概述）

Evidcoin 采用栈式脚本语言，提供基本图灵完备性。脚本用于表达交易验证逻辑（锁定/解锁）、存证识别、以及通过介管脚本实现的跨交易逻辑编排。

核心特性：
- **栈式执行**：基于 LIFO 数据栈，所有操作通过预定义指令完成。
- **无自定义函数**：降低风险，便于审计。
- **实参空间设计**：解耦指令顺序依赖，提升灵活性。
- **受限图灵完备**：支持完整流程控制（`IF/ELSE/SWITCH/EACH`），但通过参数限定约束资源消耗。


## 2. Execution Environment（执行环境）

### 2.1 Core Components（核心组件）

| 组件 | 说明 |
|------|------|
| 数据栈（Data Stack） | `[]any` 结构，LIFO。指令从中获取实参、写入返回值 |
| 实参区（Argument Area） | 队列结构。预存实参以解耦指令顺序。一次性取出 |
| 局部域（Local Scope） | 块级私有储值空间，仅当前语法块可访问 |
| 全局域（Global Scope） | 整个脚本共享的储值空间 |
| 导出缓存（Output Buffer） | 非阻塞。外部注册监听，数据驱动触发 |
| 导入缓存（Input Buffer） | 阻塞式。无数据时失败并正常退出。公共验证节点视为隐式 `END` |

### 2.2 Argument Resolution（实参解析）

指令获取实参的优先级：
1. 先从实参区取值（如果有）。
2. 实参区无值时从数据栈取值。

实参区的参数配置：
- `0`：无需实参。
- `n`：固定数量，实参区条目数必须匹配。
- `-1`：不定数量，仅从实参区取值，不访问数据栈。

### 2.3 Instruction Structure（指令结构）

每条指令由以下部分组成：

```
指令码（1 字节） + 附参（可选，静态） + 关联数据（可选）
```

- **指令码**：1 字节，唯一标识。最多 255 个基础指令。
- **附参**：编译时固化的属性参数。如 `IF` 的代码块长度、`GOTO` 的跳转目标。
- **关联数据**：指令控制的数据块。如 `DATA{}` 的字节序列、`IF{}` 的子语句块。


## 3. Instruction Set（指令集架构）

### 3.1 Segments（指令码段）

| 段名 | 码位 | 数量 | 说明 |
|------|------|------|------|
| 基础指令段 | [0-169] | 170 | 流程控制、运算、栈操作、模式匹配等 |
| 函数指令段 | [170-209] | 40 | 常用基础函数 + 1 个自扩展指令 |
| 模块指令段 | [210-249] | 40 | 标准模块 + 1 个自扩展指令 |
| 扩展指令段 | [250-253] | 4 | 2 个基础扩展 + 2 个私有扩展 |

### 3.2 Instruction Categories（指令类别）

18 个功能类别：

| # | 类别 | 代表指令 | 码位范围 |
|---|------|---------|---------|
| 1 | 值指令 | `NIL`, `TRUE`, `DATA{}` | [0-...] |
| 2 | 截取指令 | `@`, `$`, `~` | |
| 3 | 栈操作 | `PUSH`, `POP`, `TOP` | |
| 4 | 集合指令 | `SLICE`, `MERGE`, `FILTER` | |
| 5 | 交互指令 | `OUTPUT`, `INPUT` | |
| 6 | 结果指令 | `PASS`, `GOTO`, `RETURN`, `EXIT` | |
| 7 | 流程控制 | `IF{}`, `ELSE{}`, `SWITCH`, `EACH{}`, `BREAK` | |
| 8 | 转换指令 | `BOOL`, `FLOAT`, `STRING` | |
| 9 | 运算指令 | `+`, `-`, `*`, `/`, `%`, `REP`, `DEL` | |
| 10 | 比较指令 | `EQUAL`, `GT`, `WITHIN` | |
| 11 | 逻辑指令 | `BOTH`, `EITHER`, `SOME` | |
| 12 | 模式指令 | `MODEL{}`, `#`, `_`, `?` | |
| 13 | 环境指令 | `IN{}`, `OUT{}`, `VAR` | |
| 14 | 工具指令 | `EVAL`, `COPY`, `MATCH`, `RANGE` | |
| 15 | 系统指令 | `SYS_TIME`, `SYS_CHKPASS`, `SYS_AWARD` | [164-169] |
| 16 | 函数指令 | `FN_CHECKSIG`, `FN_PUBHASH`, `FN_HASH512` | [170-209] |
| 17 | 模块指令 | `MO_RE`, `MO_TIME`, `MO_MATH` | [210-249] |
| 18 | 扩展指令 | `EX_FN`, `EX_INST` | [250-253] |

### 3.3 Naming Convention（命名规范）

| 前缀 | 类别 | 示例 |
|------|------|------|
| （无） | 基础功能 | `PASS`, `IF`, `TRUE` |
| `SYS_` | 系统调用 | `SYS_TIME`, `SYS_CHKPASS` |
| `FN_` | 功能函数 | `FN_CHECKSIG`, `FN_HASH512` |
| `MO_` | 模块引用 | `MO_MATH`, `MO_RE` |
| `EX_` | 扩展定制 | `EX_FN`, `EX_INST` |


## 4. Key Instructions（关键指令）

### 4.1 SYS_CHKPASS（系统验证）

内置的交易验证指令，支持单签和多签。

```
SYS_CHKPASS( 签名类型, 授权标记, []签名, []公钥, []公钥哈希 )
```

- 签名类型：1 = 单签，2 = 多签。
- 实参从环境提取（非数据栈），这是特例。
- 本指令也是通关指令，验证失败则退出。
- 解锁数据中的签名相关数据载入环境而非数据栈。

### 4.2 GOTO（跨交易跳转）

```
GOTO[年度, 交易ID, 输出序位]
```

- 跳转到另一笔交易的输出脚本（介管脚本），在独立子环境中执行。
- 子环境继承部分调用环境，数据栈为临时的。
- 子环境的 PASS/失败结果写回顶层调用者。
- 跳转次数限制：主脚本层面 ≤ 2 次，深度 ≤ 3 次。

### 4.3 Hash Functions（哈希函数族）

`FN_HASH224`, `FN_HASH256`, `FN_HASH384`, `FN_HASH512`：

- 附参指定算法标识：sha3（默认）、sha2、blake2。
- 返回对应长度的字节序列。

### 4.4 SYS_AWARD（兑奖验算）

```
SYS_AWARD[兑奖比率]( 奖励块高度 )
```

- 仅用于 Coinbase 交易的输出脚本。
- 按设计规则检查兑奖条件是否满足。


## 5. Security Constraints（安全约束）

### 5.1 Parameter Limits（参数限定）

| 约束项 | 限制值 |
|--------|--------|
| 数据栈高度 | < 256 |
| 栈数据项大小 | < 1KB |
| 锁定脚本长度 | < 1KB |
| 解锁脚本长度 | < 4KB |
| 单笔交易大小（不含解锁） | < 8KB |
| 输出项数量 | < 1024 |
| EMBED 嵌入次数 | ≤ 5（含子脚本） |
| EMBED 嵌入深度 | = 0（嵌入脚本不可再嵌入或跳转） |
| GOTO 跳转次数 | ≤ 2（主脚本层面） |
| GOTO 跳转深度 | ≤ 3 |

### 5.2 Unlock Script Restriction（解锁脚本限制）

解锁脚本仅允许使用码值 `[0-49]` 的指令：值指令、截取指令、栈操作、集合指令、交互指令。禁止流程控制和运算类指令，防止 `TRUE PASS EXIT` 等攻击。

### 5.3 Block Size Limits（区块限额）

| 时期 | 限额 |
|------|------|
| 第 1~3 月 | 固定 1MB |
| 第 4~36 月 | 逐月递增 1MB，最终 34MB |
| 第 4 年起 | 逐年递增 2MB |


## 6. External Interaction（外部交互）

### 6.1 Output（导出）

- 非阻塞式。触发已注册的外部监听。
- 通常用于链外事务（中间件模式）。
- 监听是私有部署。

### 6.2 Input（导入）

- 阻塞式。缓存区无数据时失败但正常退出。
- 公共验证节点视 `INPUT` 为隐式 `END`。
- 通常用于私有逻辑。


## 7. Script Notation（书写约定）

| 符号 | 含义 |
|------|------|
| `{}` | 关联数据（子语句块、数据内容） |
| `[]` | 附参值 |
| `()` | 文档说明中的附参长度 |
| `<>` | 命名数据（如 `<pubKey>`, `<sig>`） |

