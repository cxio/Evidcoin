# Evidence Design（信用结构设计）

## 1. Overview（概述）

Evidcoin 定义了三种基本信元（Evidence Unit），作为通用信用载体系统的核心数据模型。信元是交易输出项的内容主体，表达不同性质的信用：

| 信元 | 本质 | 可拆分 | 可转移 | UTXO 成员 |
|------|------|--------|--------|-----------|
| 币金（Coin） | 价值计量 | 是 | 是 | 是（花费前） |
| 凭信（Credit） | 信用凭证 | 否 | 是 | 是（转移/到期前） |
| 存证（Proof） | 存在性证明 | 否 | 否 | 否 |


## 2. Coin（币金）

### 2.1 Definition（定义）

表达具体的价值额度，类似货币/代币。可拆分、合并。原始创建由区块铸造者通过 Coinbase 交易完成。

### 2.2 Data Fields（数据字段）

| 字段 | 类型 | 说明 |
|------|------|------|
| `Address` | `[48]byte` | 接收者地址（公钥哈希，SHA-384） |
| `Amount` | `varint` | 金额，最小单位 `chx` |
| `Postscript` | `[]byte` | 附言，可选，最长 255 字节 |
| `LockScript` | `[]byte` | 锁定脚本（< 1KB） |

### 2.3 Receiver Address（接收者地址）

- **单签名地址**：公钥的 SHA-384 哈希，编码为文本形式。
- **多签名地址**：N 个公钥各自哈希后，有序串连并前置 `m/N` 配比，再计算复合哈希。
- **隐私性**：单签和多签地址外观无区别。
- **特殊地址**：`null` 地址表示销毁，输出不进入 UTXO 集。
- **自定义接收者**：用户可在脚本中自行验证，此时接收者字段可为任意值（< 256 字节）。

### 2.4 Address Encoding（地址编码）

编码规则（文本形式）：
1. 公钥哈希前置识别前缀 → 执行 2 次哈希运算 → 取末尾 4 字节为校验码。
2. 公钥哈希 + 校验码（无前缀） → Base32 编码。
3. 前缀 + 编码文本 = 账户地址。

校验流程为编码的逆过程，对比校验码即可。


## 3. Credit（凭信）

### 3.1 Definition（定义）

表达信用凭证，不可拆分，可转移。数据可为文本或二进制私有格式。存在于 UTXO 集中直到转移或到期。

### 3.2 Data Fields（数据字段）

| 字段 | 类型 | 说明 |
|------|------|------|
| `Address` | `[48]byte` | 接收者地址 |
| `Creator` | `[]byte` | 创建者（< 256 字节）或创建者引用 |
| `Config` | `uint16` | 2 字节配置位 |
| `Title` | `[]byte` | 标题（< 256 字节） |
| `Description` | `[]byte` | 描述，长度由 Config 低 10 位指定（< 1KB） |
| `AttachmentID` | `[]byte` | 附件 ID，可选（< 256 字节） |
| `LockScript` | `[]byte` | 锁定脚本 |

### 3.3 Config Bits（配置位定义）

```
Bit 15: 新建标记 — 初始凭空创建时置位
Bit 14: 可否修改 — 允许下家修订描述
Bit 13: 是否修改 — 当前已修改时置位
Bit 12: （未用）
Bit 11: 转移计次 — 后跟 2 字节转移次数
Bit 10: 有效期限 — 后跟 4 字节有效期（秒）
Bit [0-9]: 描述内容长度（< 1KB）
```

### 3.4 Lifecycle（生命周期）

- **创建**：无输入项，任何人可凭空创建。置位新建标记。
- **转移**：类似币金的花费。接收者和锁定脚本可更改。可修改凭信允许修订描述。
- **到期**：转移计次用尽或有效期到达后，从 UTXO 集移除。移除时机：在凭信转移验证时被动检查。
- **修改性封锁**：可修改 → 不可修改（单向，不可逆）。

### 3.5 Compliance Rules（合规性检查）

- **不可修改凭信**：仅接收者和锁定脚本可变，创建者为引用。
- **可修改凭信**：仅描述可改变，须置位"是否修改"标记。
- **不可变字段**：创建者、标题、附件 ID 在任何转移中不可更改。


## 4. Proof（存证）

### 4.1 Definition（定义）

表达存在性。不可拆分，不可转移。不进入 UTXO 集，永久存在于链上。

用途：原始版权声明、证书存储、子链存根、话题索引、第三方应用的起始凭证等。

### 4.2 Data Fields（数据字段）

| 字段 | 类型 | 说明 |
|------|------|------|
| `Creator` | `[]byte` | 创建者（< 256 字节），可为空 |
| `Title` | `[]byte` | 标题（< 256 字节） |
| `Content` | `[]byte` | 内容（< 2KB），前置 2 字节长度 |
| `AttachmentID` | `[]byte` | 附件 ID，可选 |
| `IdentScript` | `[]byte` | 识别脚本 |

### 4.3 Content Length Config（内容长度配置）

```
Bit [11-15]: （未定义）
Bit [0-10]:  内容长度（字节数），最大 2KB
```

### 4.4 Identification Script（识别脚本）

存证不可作为交易输入，但其识别脚本可嵌入其他输出脚本中，供第三方识别客户端程序化处理。


## 5. Attachment（附件设计）

### 5.1 Attachment ID Structure（附件 ID 结构）

```
[1]    ID 总长
[2]    附件类型（大类 + 小类）
[1]    指纹强度（按 4 字节增量：0→16, 1→20, ..., 12→64）
[16+]  附件指纹（BLAKE3 哈希，最低 128 bit）
[2]    分片数量（< 65536）
[48]   片组哈希（二元哈希树根，叶子含前置 2 字节序号）
[~]    附件大小（变长整数，字节）
```

### 5.2 Sharding Rules（分片规则）

- 0 片：无分片，片组哈希全零。
- 1 片：等同无分片，片组哈希为附件数据哈希。
- \>1 片：含序哈希校验树计算片组哈希。叶子 = 2 字节序号 + 48 字节分片哈希。

每分片最大 **2MB**，64K 分片可表达 **128GB** 数据。

### 5.3 Shard Verification（分片验证）

1. 按序号请求目标分片数据和关联路径哈希。
2. 计算分片数据哈希 → 前置序号 → 结合路径哈希验算片组哈希。
3. 序号由验证者前置，源节点无法作弊。


## 6. Signature（签名体系）

### 6.1 Single Signature（单签名）

由单一私钥对交易签名，适用于大多数个体交易。

### 6.2 Multi-Signature（多重签名）

支持 `M-of-N` 机制。

解锁数据包含：
- **签名集**：m 个签名。
- **公钥集**：m 个对应公钥。
- **补全集**：N-m 个未签名的公钥哈希。

验证流程：
1. 计算 m/N 配比。
2. 公钥集各项计算哈希 → 与补全集混合排序串连 → 前置 m/N 配比 → 计算复合公钥哈希。
3. 对比接收者地址。
4. 逐一验证签名。

### 6.3 Authorization Flags（签名授权类型）

1 字节配置，定义签名消息的范围：

| 标志位 | 名称 | 说明 |
|--------|------|------|
| Bit 7 | SIGIN_ALL | 全部输入项 |
| Bit 6 | SIGIN_SELF | 仅当前输入项 |
| Bit 5 | SIGOUT_ALL | 全部输出项（需配合辅项） |
| Bit 4 | SIGOUT_SELF | 同序位输出项（需配合辅项） |
| Bit 3 | SIGOUTPUT | 输出项完整条目 |
| Bit 2 | SIGSCRIPT | 输出项脚本 |
| Bit 1 | SIGCONTENT | 输出项内容 |
| Bit 0 | SIGRECEIVER | 输出项接收者 |

最常见组合：`SIGIN_ALL | SIGOUT_ALL | SIGOUTPUT`（全部输入 + 全部输出完整数据）。

### 6.4 Signature Separation（签名分离设计）

- 签名数据不参与交易 ID 计算。
- 签名数据在交易入块验证后可丢弃。
- 区块链的长期安全依赖哈希链式结构（区块 ID 链 + UTXO 指纹链）的双路保护，而非签名的永久存储。

