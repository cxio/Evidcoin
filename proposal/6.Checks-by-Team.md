# Team-Based Verification（组队校验）

> **Design Proposal** — 本文档描述 Evidcoin 的组队交易校验架构，涵盖校验团队结构、角色分配、冗余与复核机制、组间协作、铸造集成、UTXO 指纹、区块发布与安全保障。


## 1. Overview（概述）

传统区块链采用“单节点”模型：每个全节点独立校验每笔交易。随着交易量增长，这对参与者的硬件要求不断提高，并限制系统吞吐上限。

Evidcoin 用 **Team-Based Verification** 取代该模型——由一组节点（*verification team*）协同校验整块交易的合作式架构。交易天然相互独立，使团队成员并行分发既合理又高效。

核心设计原则：

| 原则 | 描述 |
|-----------|-------------|
| **Division over redundancy** | 全量去中心化冗余并非必要，责任分工即可满足安全性。 |
| **Micro-centralized teams** | 团队内部有层级分工，但团队之间以自由 P2P 关系相处。 |
| **Open membership** | 任意节点可自由加入任何团队；有能力的节点可同时参与多个团队。 |
| **Low barrier** | 创建校验团队仅需管理层具备中等硬件能力，不设置人为门槛。 |


## 2. Team Structure and Roles（组结构与角色分配）

一个校验组由三类职能角色与共享的 UTXO 缓存服务构成。

```graph
┌─────────────────────────────────────────────────┐
│               Verification Team                 │
│                                                 │
│  ┌───────────────────────────────────────────┐  │
│  │         Management Layer（管理层）        │  │
│  │  ┌─────────────┐    ┌──────────────────┐  │  │
│  │  │ Broadcaster │    │    Dispatcher    │  │  │
│  │  │  （广播者） │    │    （调度者）    │  │  │
│  │  └─────────────┘    └──────────────────┘  │  │
│  └──────────┬───────────────────┬────────────┘  │
│             │                   │               │
│       ┌─────┴─────┐      ┌──────┴───────┐       │
│       │  Guards   │      │  Verifiers   │       │
│       │ （守卫者）│      │  （校验员）  │       │
│       └───────────┘      └──────────────┘       │
│                                                 │
│    ┌───────────────────────────────────────┐    │
│    │  UTXO/UTCO Cache（UTXO/UTCO 缓存器）  │    │
│    └───────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘
```


### 2.1 Management Layer（管理层）

管理层包含两个子角色：**Broadcaster** 与 **Dispatcher**。

#### 2.1.1 Broadcaster（广播者）

职责：
- 接收合格铸造者的铸造申请并组织铸造流程
  （Coinbase 创建、CheckRoot 交付、签名收集、区块头组装）。
- 打包并向网络发布最终区块。
- 若其他团队铸造区块，则接收其发布的区块、验证之、补齐本地缺失交易，并继续转发。
- 直接验证少量差异交易（存在于接收区块但不在本地已验证集合中）以提升效率与安全性。

#### 2.1.2 Dispatcher（调度者）

职责：
- 接收 Guards 的首领校验通过交易并存入待校验池。
- 以可控冗余将交易分配给 Verifiers（每笔交易至少 2 名）。
- 评估校验结果，结果不一致时触发扩展复核。
- 记录成员工作表现以用于奖励分配。
- 实时同步已验证交易集合至 Broadcaster，以便快速打包或校验区块。

#### 2.1.3 Management Layer Connections（管理层连接关系）

| 方向 | 对端 |
|-----------|-------|
| **Intra-team** | Guards（接收交易）、Verifiers（分配任务并收集结果） |
| **Inter-team** | 其他校验团队的 Broadcaster |


### 2.2 Guards（守卫者）

Guards 是团队的守门人——外部交易的唯一入口。

职责：
- 接收来自其他团队 Guards 与 Verifiers 的交易。
- 对每笔入站交易执行 **Leader Verification**（见 §3）。
- 将首领校验通过的交易提交给 Dispatcher。
- 将接收的交易转发至其他团队 Guards 以加速全网广播。
- 维护 **blacklist**：记录通过首领校验但最终未通过完整校验的交易首领输入。

管理层持续向 Guards 同步已提交交易的 ID，以防重复校验与提交。这不影响 Guard 向其他团队 Guards 转发交易的职责。

#### Guard Connections（守卫者连接关系）

| 方向 | 对端 |
|-----------|-------|
| **Intra-team** | 管理层（提交已验证交易） |
| **Inter-team** | 接收来自：其他团队 Guards 与 Verifiers。发送至：其他团队 Guards。 |


### 2.3 Verifiers（校验员）

Verifiers 负责完整交易校验。

职责：
- 向 Dispatcher 请求校验任务。
- 执行完整校验（脚本执行、输入验证、金额检查等），并将通过/失败结果回报给 Dispatcher。
- 将已验证通过的交易发送给其他团队 Guards，加速网络传播。

实现说明：
- Verifiers 不知道分配的交易是常规校验还是复核重查。这种信息不对称可抑制串谋与恶意行为。
- 若交易计算量过大，Verifier 可拒绝并返回 *overloaded*。若同一交易收到多个此类回应，Dispatcher 可降低其优先级（冷处理）。

#### Verifier Connections（校验员连接关系）

| 方向 | 对端 |
|-----------|-------|
| **Intra-team** | 管理层（请求任务、提交结果） |
| **Inter-team** | 发送至：其他团队 Guards（提供已验证交易） |


### 2.4 UTXO Cache（UTXO 缓存器）

UTXO Cache 是团队内共享服务，维护当前 UTXO 集并为 Guards 与 Verifiers 提供查询能力。

```go
// UTXOCache 提供组内 UTXO 集的缓存查询服务。
type UTXOCache interface {
    // Lookup 查询指定输出点是否未花费，并返回其信息。
    Lookup(outpoint Outpoint) (*UTXOEntry, error)

    // Update 标记一笔交易的输入为已花费，输出为新增。
    // 如果检测到双花，返回 ErrDoubleSpend。
    Update(tx *Transaction) error

    // ScriptCache 获取外部脚本缓存（GOTO/EMBED/SCRIPT 引用）。
    ScriptCache() ScriptStore
}
```

关键行为：
- 管理层确认交易有效后，将交易推送至 UTXO Cache 进行试探性应用。
- UTXO Cache 独立检测 **double-spending**，并立即向管理层报告违规，管理层据此发布全网告警。
- UTXO Cache 可集成外部脚本缓存（`GOTO`、`EMBED`、`SCRIPT` 指令引用），减少从 Blockqs/Depots 的重复拉取。


## 3. Leader Verification（首领校验）

首领校验是 Guards 对入站交易执行的轻量预检。仅校验 **first input**（“leader input”）；若通过则转入完整校验。

### 3.1 Purpose（目的）

首领校验使交易在无需完整校验成本的情况下快速传播。通过仅校验一个输入，Guards 可迅速判断交易是否可能合法并近实时转发。

### 3.2 Constraints（约束条件）

为限制滥用（如首领输入有效但后续输入无效的洪泛攻击）：

1. **The leader input must be a Coin type**（币金），且在所有 coin 输入中具有最高 coin-age（币权）。
2. **Blacklisting**：若交易通过首领校验但最终未通过完整校验，该首领输入引用被加入临时黑名单。
3. **Freeze duration**：黑名单首领输入冻结 **24 hours**，期间以该输入为首领的交易会被 Guard 拒绝。

这使洪泛攻击成本高昂：攻击者必须消耗有效且高币权的 UTXO，一旦被检测到，每个都会冻结 24 小时。


## 4. Security Mechanisms（安全保障机制）

### 4.1 Redundant Verification（冗余校验）

每笔交易分配给多个 Verifiers（冗余 ≥ 2，团队可配置）。结果合并如下：

| 结果 | 处理 |
|--------|---------|
| All Verifiers report valid | 交易被接受为有效 |
| At least one reports invalid | 交易进入 Extended Review |

### 4.2 Extended Review（扩展复核）

当校验结果不一致时，Dispatcher 升级到表现更好的 Verifiers（基于历史绩效选择）。复核同样采用冗余。

**Level 1 Review（一级复核）:**

| 结果 | 处理 |
|--------|---------|
| Zero error reports | 交易被接受为有效 |
| More than half report invalid | 交易被拒绝为无效 |
| Less than half report invalid | 升级到 Level 2 |

**Level 2 Review（二级复核）:**

| 结果 | 处理 |
|--------|---------|
| Any error report | 交易被拒绝为无效 |
| All report valid | 交易被接受为有效 |

通过扩展复核拒绝的交易不会被永久丢弃。若另一校验团队验证并将其包含在发布区块中，接收团队会在区块同步时重新校验。

### 4.3 Inter-Team Feedback（组间反馈）

Verifiers 直接将已验证交易发送给其他团队 Guards。若接收 Guard 所属团队随后判定该交易无效，Guard 会通知原始 Verifier，后者可重新校验。该跨团队反馈回路显著增强整体校验可靠性。

管理层维护每笔交易的 Guard 投递记录，使另一团队可追溯到最初的 Verifier。


## 5. Transaction Inclusion Priority（交易收录优先级）

管理层在组装区块时遵循以下优先级规则：

| 优先级 | 判据 |
|----------|-----------|
| **Highest** | 更早的输入时间戳（最老未花费输入决定交易年龄） |
| **Secondary** | 更高的币权销毁量（Stakes）或更高交易费 |


## 6. Minting Integration（铸造集成）

### 6.1 Minter Identity（铸造者身份）

仅择优池（Best Pool）成员可签名区块。铸造竞争向所有角色开放——管理层、Guards、Verifiers，甚至不参与校验工作的 spectators（围观者）。

管理层不知道哪些节点具备铸造资格（铸造预选与交易校验无关）。铸造者可同时参与多个团队，理论上可能签多个区块。

### 6.2 Lowest-Revenue Principle（低收益原则）

为防止铸造者为获利而签名多个竞争区块：

> **Rule**: When the same minter signs multiple blocks at the same height, only the block
> with the **lowest revenue** is considered valid.

该规则消除多签激励，并防止团队用新到达高费交易重打包区块而拖延出块。

### 6.3 Information Separation（信息分离）

铸造流程刻意在铸造者与管理层之间进行信息隔离，形成相互制衡：

- **minter** 构造 Coinbase 交易，但不知道完整区块的 `CheckRoot`（交易哈希树根与 UTXO 指纹的组合哈希）。
- **Management Layer** 知道 `CheckRoot`，但无法伪造铸造者签名。

该隔离防止任何一方单方面作弊。

### 6.4 Minting Workflow（铸造流程）

```graph
Minter                         Management Layer
  │                                   │
  │  1. Submit Best Pool proof        │
  ├──────────────────────────────────>│
  │                                   │
  │  2. Return: fee total, reward     │
  │     addresses, minting amount,    │
  │     service reward addresses      │
  │<──────────────────────────────────┤
  │                                   │
  │  3. Construct & submit Coinbase   │
  ├──────────────────────────────────>│
  │                                   │  Verify Coinbase,
  │                                   │  package block,
  │                                   │  compute hash tree
  │  4. Return: Coinbase Merkle path, │
  │     TreeRoot, UTXO fingerprint    │
  │<──────────────────────────────────┤
  │                                   │
  │  Verify Coinbase is included      │
  │  (via Merkle path)                │
  │                                   │
  │  5. Sign CheckRoot, submit        │
  ├──────────────────────────────────>│
  │                                   │  Verify signature,
  │                                   │  assemble block header,
  │                                   │  publish block
  │  6. Block published               │
  │<──────────────────────────────────┤
```

说明：
- 区块头由管理层创建，使其对版本控制与结构决策具有自主权。
- 铸造者在签名前使用返回的 Merkle 路径验证其 Coinbase 交易是否被包含。
- 若铸造者指定的公共服务奖励地址被管理层拒绝，铸造者将无法获得签名数据，可转而尝试其他团队。

### 6.5 Spectator Participation（围观者参与）

铸造竞争与校验工作相互独立。为最大化铸造候选池（通过更广泛竞争提升安全性），校验团队允许非校验节点——**spectators**——加入成为铸造候选者。

这在事实上不可避免：如果 spectator 赢得择优池竞争，必须能进入团队执行铸造流程。

管理层向 spectator 铸造者提供可选信息：
- 建议的公共服务奖励地址
- Coinbase 交易的奖励槽标记

以上仅为建议，最终由铸造者裁量。

### 6.6 Anti-Selfish-Minting: Stakes Threshold（防自私铸造：币权阈值）

铸造者理论上可在不依赖团队协助的情况下生成空块（仅含 Coinbase 交易），因为只需前一区块 ID 与当前 UTXO 指纹。

To deter this:

> **Rule**: If a candidate block's total Stakes destruction exceeds the primary block's
> Stakes by a factor of **3×**, the candidate block wins.

这确保以近乎零 Stakes 自私铸造的主块会被任何校验了约 1/3 可用交易的候选块取代。对单个 spectator 或个人 Verifier 而言，实现 1/3 交易量并不现实。

| 术语 | 定义 |
|------|------------|
| **Primary block** | 由择优池排名第一候选者铸造的区块 |
| **Candidate block** | 由次排名候选者铸造的区块（冗余安全） |


## 7. Block Publication（区块发布）

区块发布为提升网络效率而优化，分三阶段进行：

### 7.1 Stage 1: Block Proof Broadcast（广播区块证明）

首先广播最小证明数据：
- Coinbase 交易
- Coinbase Merkle 验证路径（连接 Coinbase 与 TreeRoot 的哈希序列）
- 铸造者签名
- 区块头

这使接收团队无需下载全部交易即可立即验证区块真实性。

### 7.2 Stage 2: Block Summary（发布区块概要）

发布完整交易 ID 列表，并进行优化：
- 每个交易 ID **truncated to the first 16 bytes**，按序传输。
- 64K 交易的区块：`64K × 16 = 1 MB` 数据。
- 接收者将截断 ID 与本地已验证交易集对比。
- 缺失或歧义项（哈希前缀碰撞，极少发生）将触发请求完整 ID。

### 7.3 Stage 3: Transaction Synchronization（同步交易数据）

同步区块内所有交易的完整数据。由于多数团队已验证大部分交易，仅需获取少量缺失交易。接收者随后：
1. 重建交易哈希树。
2. 将计算得到的树根与区块头 `CheckRoot` 对比验证。
3. 接受或拒绝区块。


## 8. UTXO Fingerprint（UTXO 指纹）

### 8.1 Structure（结构）

UTXO 指纹是对整个 UTXO 集的 4 级层次哈希，用于在单个输出变化时最小化重算：

```
Level 1: Year         ─── Year of the transaction timestamp (UTC)
Level 2: Transaction  ─── Transaction ID within that year
Level 3: Output       ─── Output index within the transaction
Level 4: Hash Leaf    ─── SHA-512 hash of the output data
```

```graph
┌────────────────────────────────────┐
│         UTXO Fingerprint           │
│         (top-level hash)           │
└──────────────────┬─────────────────┘
                   │
    ┌────────────┬─┴────────┬─────────┐
  Year₁        Year₂       Year₃     ...
    │
  ┌─┴────┬───────┬──────┐
 Tx_A   Tx_B    Tx_C   ...
  │
 ┌┴────┬─────┐
Out₀  Out₁  ...
 │
Hash(output data)
```

### 8.2 Computation Efficiency（计算效率）

当交易花费某输出时：
1. 仅移除受影响的 **Output** 哈希。
2. 基于剩余输出重算父级 **Transaction** 哈希。
3. 重算父级 **Year** 哈希。
4. 重算顶层 **Fingerprint**。

大多数年度哈希保持不变，使增量更新更高效。

### 8.3 Dual-Chain Protection（双链保护）

UTXO 指纹与区块 ID 链结合，形成区块链历史的 **dual-chain protection** 机制：

- **Block ID chain**：每个区块头包含 `PrevBlock`，顺序链接区块。
- **UTXO fingerprint chain**：每个区块的 `CheckRoot` 纳入 UTXO 指纹，汇总历史交易结果。

攻击者必须同时伪造两条链才能篡改历史——区块头与累积 UTXO 状态——使历史重构在实践中不可行。

### 8.4 Chain Constraint（链式约束）

关键定义：
- **Current block**：当前正在校验与组装的区块。
- **Current UTXO set**：当前区块交易所针对的 UTXO 集，**not** 包含当前区块自身的花费影响。

当前区块的 UTXO 指纹由 *current UTXO set* 计算（即前一区块交易的结果）。这提供充分计算时间，并形成递归链式约束：

```graph
UTXO Set(N) ──fingerprint──► Block(N).CheckRoot
    │
    │  Apply Block(N) transactions
    ▼
UTXO Set(N+1) ──fingerprint──► Block(N+1).CheckRoot
```

**Reverse verification**：给定当前 UTXO 集与某区块交易，可反推前一区块的 UTXO 集并与其区块头指纹比对。该过程可迭代至任意历史深度。

### 8.5 New Node Bootstrap（新节点引导）

得益于 UTXO 指纹，新加入节点仅需：
1. 区块头链（或用于旧历史的年块骨架）
2. 最近约 9 个完整数据区块
3. 当前 UTXO 集

该最小数据集使节点能够高置信验证当前链状态，大幅降低入门门槛。


## 9. Optimal Team Size（最优规模）

团队越大未必越好。以 6 分钟出块、每块最多 64K 交易估算：

- 吞吐：约 182 笔/秒
- 预计足够规模：**50–60 nodes**

Verifiers 自由领取任务——能力强者处理更多、弱者处理更少。该自适应负载分配自然平衡团队。


## 10. Hash Verification Tree with Ordered Leaves（含序哈希校验树）

用于区块交易的哈希校验树支持 **ordered leaf nodes**：每个叶子（交易 ID）包含 3 字节序号前缀，从而实现：

| 能力 | 描述 |
|------------|-------------|
| **Random sampling** | 无需下载全部交易即可抽检树中任意位置 |
| **Positional extraction** | 按区块内位置定位并验证特定交易 |
| **Sync optimization** | 在节点同步时识别缺失交易的位置（不仅是 ID） |

该结构也用于附件分片哈希树，可对大文件附件进行局部验证。


## 11. Known Limitations（已知不足）

| 限制 | 描述 |
|------------|-------------|
| **Trust in Management Layer** | 铸造者必须将收益发送至管理层指定的地址，需一定信任。 |
| **Self-minting Management** | 若管理层自身为铸造者，缺乏机制阻止其保留全部收益，仅能通过团队间充分竞争来缓解。 |
| **Evaluation subjectivity** | 公共服务奖励评估是局部且概率性的，非全局可验证（见 Services 提案 §4）。 |


## 12. Inter-Team Topology（组间拓扑）

```graph
  ┌──────────┐         ┌──────────┐         ┌──────────┐
  │  Team A  │         │  Team B  │         │  Team C  │
  │          │         │          │         │          │
  │ Broad.<──┼────────>┼──>Broad. │<───────>┼──>Broad. │
  │          │         │          │         │          │
  │ Guard <──┼────┐    │  Guard <─┼───┐     │  Guard   │
  │          │    │    │          │   │     │          │
  │ Verif.───┼────┼───>┼──>Guard  │   │     │          │
  │          │    │    │  Verif.──┼───┼────>┼──>Guard  │
  └──────────┘    │    └──────────┘   │     └──────────┘
                  │                   │
                  └───────────────────┘
```

- **Broadcaster ↔ Broadcaster**：团队之间区块交换的全互联。
- **Verifier → Guard**：跨团队投递已验证交易。
- **Guard ← Guard/Verifier**：跨团队接收入站交易。

每个团队是半开放的微中心：内部分层、外部 P2P。
