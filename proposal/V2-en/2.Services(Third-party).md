# Third-Party Public Services Design Proposal（公共服务设计提案）

This document describes the architecture, incentive mechanisms, and sustainability model for Evidcoin's third-party public service networks.


## 1. Service Architecture Overview（服务架构概述）

Evidcoin decomposes the traditional monolithic blockchain node into specialized, independent P2P service networks. This separation reduces per-node hardware requirements and lowers the barrier to participation.

### 1.1 Base Network and Sub-Networks（基网与子网）

The architecture follows a two-tier model:

- **Base Network (基网)**: A lightweight P2P network providing universal node discovery via broadcast-search mechanisms. All other networks are built on top of it. The base network is an open "free market" for P2P nodes — any application node can discover peers of the same kind or locate service nodes through it.

- **Sub-Networks (子网)**: Specialized service networks that self-organize on top of the base network. Each sub-network's nodes interconnect among themselves while simultaneously serving application peers that connect in.

The base network is implemented by an external library ([cxio/p2p](https://github.com/cxio/p2p)). Evidcoin only needs to define clean interfaces for interaction with this layer.

### 1.2 Relationship Diagram（关系图）

```
                    ┌─────────────────────────────────────┐
                    │         Base Network (基网)          │
                    │     Node Discovery & Broadcast       │
                    └──┬──────────┬──────────┬────────────┘
                       │          │          │
              ┌────────▼──┐ ┌────▼─────┐ ┌──▼──────┐
              │  Depots    │ │ Blockqs  │ │ STUN    │
              │ (数据驿站) │ │(区块查询)│ │(stun2p) │
              └────┬───┬──┘ └──┬───┬───┘ └──┬──┬───┘
                   │   │       │   │        │  │
                   │   └───┐   │   └────┐   │  │
                   │       │   │        │   │  │
              ┌────▼───────▼───▼────────▼───▼──▼───┐
              │       Blockchain Peers (应用节点)    │
              └────────────────────────────────────┘
```

- Single arrows indicate support (service provision).
- Peers connect to service nodes for functionality; service nodes interconnect among themselves for coordination.


## 2. Service Network Descriptions（各服务网络描述）

### 2.1 Data Depots — `depots`（数据驿站）

**Purpose**: Persistent storage and P2P file-sharing of blockchain data, including complete blocks and transaction attachments.

**Key characteristics**:

- Operates as a file-sharing network, suitable for large data objects.
- Nodes coordinate storage decisions through **data signaling** — exchanging information about data existence and scarcity across the network.
- **Scarcity sensing**: When a data query is broadcast, nodes that hold the target data respond and stop relaying. Nodes without the data increment a hop counter and relay onward. The hop count serves as a rough measure of data scarcity — higher hops indicate rarer data, informing storage decisions.
- **Data heartbeat**: Charitable nodes periodically probe cold or low-demand data to maintain its availability across the network. For blockchain attachments, the chain itself provides a definitive catalog for systematic probing.
- **Data upload**: When an application node queries the network for data it has originated, the query triggers nearby nodes' supplementary-storage behavior, allowing the originating node to serve as the initial data source.

**Query mechanism**: Data discovery uses the base network's broadcast-search mechanism, with customized implementations per sub-network.

**Scope boundary**: Attachments smaller than 10 MB (typically ≤ 2 MB) or shard index files for larger attachments may also be served by Blockqs. Complete blocks and attachments ≥ 10 MB are the responsibility of Depots.

**Project**: [github.com/cxio/depots](https://github.com/cxio/depots)

### 2.2 Block Query Service — `blockqs`（区块查询）

**Purpose**: High-performance query service for blockchain transaction data, designed for fast responses to small data requests.

**Supported query types**:

| Query Type | Description |
|---|---|
| **Script** | General retrieval of transactions and their outputs |
| **Script Set** | Fetch all outputs of a target transaction |
| **Transaction** | Retrieve complete transaction data |
| **UTXO** | Check whether a target output has been spent |
| **Transaction ID Set** | Retrieve transactions associated with an account (address) |
| **Attachment** | Small attachments (< 10 MB) or shard index files for larger ones |

**Operational model**:

- Blockqs nodes connect to the blockchain network they serve, receiving and storing transaction data in real time.
- Newly launched Blockqs nodes can bootstrap historical data from Depots.
- When connecting to a blockchain peer, a Blockqs node presents its own blockchain address for potential reward distribution.

**Project**: [github.com/cxio/blockqs](https://github.com/cxio/blockqs)

### 2.3 NAT Traversal Service — `stun2p`（NAT服务）

**Purpose**: NAT detection and hole-punching service network, enabling UDP-based P2P connections for nodes behind NAT.

**Characteristics**:

- Essential for nodes operating within NAT-restricted environments.
- Provides NAT type detection and assists with hole-punching.
- Generic service — useful for any P2P application, not limited to blockchain.

**Project**: [github.com/cxio/stun2p](https://github.com/cxio/stun2p)


## 3. Connection Security（连接安全）

All P2P connections use self-signed certificates with **SPKI fingerprint verification**. Certificates have a reasonable validity period of approximately **30 days**. This approach avoids reliance on certificate authorities while maintaining authenticated, encrypted connections between peers.


## 4. Minting Schedule（铸造时间表）

With a fixed block interval of **6 minutes**, the system produces **87,661 blocks per year** (based on the sidereal year of 365.25636 days).

### 4.1 Pre-release Phase（预发布阶段） — Years 1–3

A three-year trial period with progressively increasing mint rates, preventing early participants from accumulating disproportionate holdings:

| Year | Mint Rate (coins/block) | Annual Mint | Cumulative Total |
|------|------------------------|-------------|------------------|
| 1 | 10 | 876,610 | 876,610 |
| 2 | 20 | 1,753,220 | 2,629,830 |
| 3 | 30 | 2,629,830 | 5,259,660 |

### 4.2 Formal Issuance Phase（正式发行阶段） — Starting Year 4

- Begins at **40 coins/block**.
- Reduces by **20%** every **2 years**.
- Calculations use whole coin units (not satoshis) to avoid prolonged micro-issuance.
- Ends when the rate reaches **3 coins/block**.

| Years | Mint Rate (coins/block) | Period Mint | Cumulative Total |
|-------|------------------------|-------------|------------------|
| 4–5 | 40 | 7,012,880 | 12,272,540 |
| 6–7 | 32 | 5,610,304 | 17,882,844 |
| 8–9 | 25 | 4,383,050 | 22,265,894 |
| 10–11 | 20 | 3,506,440 | 25,772,334 |
| 12–13 | 16 | 2,805,152 | 28,577,486 |
| 14–15 | 12 | 2,103,864 | 30,681,350 |
| 16–17 | 9 | 1,577,898 | 32,259,248 |
| 18–19 | 7 | 1,227,254 | 33,486,502 |
| 20–21 | 5 | 876,610 | 34,363,112 |
| 22–23 | 4 | 701,288 | 35,064,400 |
| 24–25 | 3 | 525,966 | 35,590,366 |

### 4.3 Long-term Phase（长期阶段）

After the formal issuance ends, the system maintains a perpetual low-inflation rate of **3 coins/block** (~262,983 coins/year). This ensures that miners always have a baseline revenue stream, independent of transaction fee volume.

> **Note**: Long-term inflationary minting is effectively a system-wide tax. At an appropriately low rate, this is a reasonable tradeoff for sustained network security.


## 5. Deflation Mechanism（通缩机制）

### 5.1 The 50% Fee Burn Rule（50%费用燃烧规则）

Transaction fees represent the difference between input and output coin values in a transaction. Evidcoin applies a **50% burn** to all transaction fees:

- Only **50%** of the total transaction fees in a block are credited to the Coinbase output.
- The remaining **50%** is permanently destroyed (burned).
- The burned amount is verified computationally — it is never stored or recorded as a UTXO. Validators simply confirm that the Coinbase revenue equals: `minting_reward + 50% × total_fees + reclaimed_unclaimed_rewards`.

### 5.2 Dynamic Equilibrium（动态平衡）

This creates a self-regulating feedback loop:

1. **When transaction volume is high** → more fees burned → total supply decreases → coin value rises → transactions become more expensive → activity moderates.
2. **When transaction volume is low** → fewer fees burned → supply grows from minting → coin value decreases → transactions become cheaper → activity increases.

This mechanism, combined with the perpetual 3 coins/block minting, produces a **dynamic inflation-deflation market** that tends toward long-term value stability.

### 5.3 Worked Example（计算示例）

Assume a block containing 50,000 transactions with an average fee of 0.00012 bi:

```
Total fees:        50,000 × 0.00012 = 6 bi
Burned (50%):      3 bi
Retained fees:     3 bi
Minting reward:    3 bi
Block revenue:     3 + 3 = 6 bi
Net supply change: +3 (minted) − 3 (burned) = 0 (equilibrium)
```


## 6. Revenue Distribution（收入分配）

### 6.1 Coinbase Transaction Structure（铸币交易结构）

The Coinbase transaction is a special transaction in each block that encapsulates all block revenue. Its total revenue consists of:

```
Total Revenue = Minting Reward
              + Retained Transaction Fees (50% of total fees)
              + Reclaimed Unclaimed Rewards (from blocks that failed redemption)
```

### 6.2 Distribution Ratios（分配比例）

The total revenue is distributed among five categories of recipients:

| Recipient | Share | Description |
|-----------|-------|-------------|
| **Validators (校验组)** | 40% | The team that validated and minted the block |
| **Evidence Minter (铸凭者)** | 10% | The provider of the minting-evidence transaction |
| **Depots** | 20% | Data storage and file-sharing service |
| **Blockqs** | 20% | Block query and transaction retrieval service |
| **STUN** | 10% | NAT traversal service |

> **Note**: Division uses integer arithmetic. Any remainder from rounding is retained by the last recipient in the distribution sequence.

### 6.3 Coinbase Outputs（Coinbase 输出项）

The Coinbase transaction contains outputs for each recipient category:

1. **Validator output** — paid to the minting team's address (40%).
2. **Evidence Minter output** — paid to the evidence transaction provider (10%).
3. **Depots reward output** — paid to a selected Depots node address (20%).
4. **Blockqs reward output** — paid to a selected Blockqs node address (20%).
5. **STUN reward output** — paid to a selected STUN node address (10%).

Service nodes present their blockchain address upon connecting to application peers, enabling minters to identify eligible reward recipients.


## 7. Reward Redemption Mechanism（奖励兑换机制）

### 7.1 Design Rationale（设计原理）

The minter of a block can freely designate the three public-service reward recipients — even nodes that did not actually provide service. There is no on-chain enforcement of service quality at the point of award.

However, **redemption** of rewards is gated by subsequent minters' confirmation, creating an indirect quality filter.

### 7.2 Confirmation Rules（确认规则）

Within the **48 blocks** following the award (~4.8 hours), at least **2** subsequent minters must confirm the award for full redemption:

| Confirmations | Portion Released | Cumulative Redeemable |
|---------------|------------------|-----------------------|
| 1 | 50% | 50% |
| 2 | 50% | 100% |

- Each subsequent minter carries a **confirmation slot** (兑奖槽) in their Coinbase transaction — a 144-bit (18-byte) bitmap covering 3 services × 48 blocks.
- A minter evaluates each of the 144 pending rewards and sets the corresponding bit if the target service node is deemed satisfactory.
- If an award fails to receive 2 confirmations within 48 blocks, the unclaimed portion is **reclaimed** by the 49th block's Coinbase as additional revenue.

### 7.3 Early Redemption（提前兑现）

If a reward achieves 2 confirmations before the 48-block window expires, it may be redeemed after **25 blocks** (when fork risk is eliminated).

### 7.4 Evaluation Methods（评估方法）

Each service type has a practical evaluation approach:

| Service | Evaluation Method |
|---------|-------------------|
| **STUN** | Request NAT detection and hole-punching from connected stun2p nodes; assess by connectivity, accuracy, and response time |
| **Depots** | Request random on-chain blocks, transactions, or attachments (or individual shards for large files); assess data completeness and response quality |
| **Blockqs** | Validators maintain close connections with Blockqs nodes; normal reachability and performance assessment applies |

### 7.5 Cache Pool for Evaluation（评估缓存池）

Validators maintain a cache of service nodes that have provided good service. This cache is consulted when confirming rewards in subsequent blocks.

For a service network of ~10,000 nodes:

- **Evaluators per cycle**: 48 / 2 = 24 blocks can contribute confirmations per award.
- **Required cache size**: ~10,000 / 24 ≈ 416 service addresses.

In practice, overlap reduces the effective cache requirement. The cache size scales with network size — larger networks have lower per-node hit rates and may require tuning.


## 8. Long-term Sustainability Analysis（长期可持续性分析）

### 8.1 Revenue Guarantee（收益保障）

The perpetual 3 coins/block minting ensures that even with zero transaction fees, public service nodes receive a non-zero reward:

```
Per block (zero-fee scenario):
  Total revenue:     3 coins
  Depots:            3 × 20% = 0.6 coins
  Blockqs:           3 × 20% = 0.6 coins
  STUN:              3 × 10% = 0.3 coins
```

This baseline prevents the "empty block" problem where service nodes have no incentive to operate.

### 8.2 Incentive Alignment（激励对齐）

The system aligns incentives across participants:

- **Minters** benefit from a healthy service network — without Blockqs and Depots, ordinary nodes cannot efficiently participate, reducing transaction volume and fee revenue.
- **Service nodes** are incentivized by direct block rewards proportional to their service quality (filtered through the redemption mechanism).
- **Users** benefit from lower hardware requirements and better access to blockchain data through specialized service nodes.

### 8.3 The "Stingy Blockchain" Consideration（吝啬的区块链）

Rewarding external service nodes is not enforced — a blockchain could theoretically redirect all rewards to insiders. However:

- A blockchain's value derives from external users' trust and adoption.
- A stingy blockchain that neglects its service infrastructure loses competitiveness.
- Since Evidcoin is open-source, competing chains can adopt the same technology with fairer incentive distributions.
- Allocating block revenue to external services is not a loss — it is an investment in the ecosystem that generates that revenue.

### 8.4 Generality of Services（服务通用性）

Because node discovery and data storage are common needs across P2P applications, Depots and STUN nodes may optionally serve non-blockchain P2P applications as well. This creates a broader P2P ecosystem where:

- Service nodes can diversify their "customer base" beyond a single blockchain.
- Non-blockchain applications benefit from existing infrastructure.
- The ecosystem becomes more resilient through diversification.

### 8.5 Security Considerations（安全性考虑）

The local-evaluation model (局部评估) accepts that no single minter has a global view of all service nodes. This is a deliberate tradeoff:

- Awarding a non-existent or non-functional service node is pointless — subsequent minters will not confirm it.
- Self-awarding to one's own service node is acceptable — the node must still provide verifiable service.
- The low confirmation threshold (2 out of 48) accommodates the inherently local visibility of P2P networks.
- The 48-block window (~4.8 hours) provides ample time for confirmation while keeping unclaimed funds from being locked indefinitely.
