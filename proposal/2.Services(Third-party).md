# Third-Party Public Services Design Proposal（公共服务设计提案）

本文档描述 Evidcoin 第三方公共服务网络的架构、激励机制与可持续性模型。


## 1. Service Architecture Overview（服务架构概述）

Evidcoin 将传统的一体化区块链节点拆分为多个专用、相互独立的 P2P 服务网络。这种分离降低了单节点硬件需求，并降低了参与门槛。

### 1.1 Base Network and Sub-Networks（基网与子网）

该架构采用两层模型：

- **Base Network (基网)**：轻量级 P2P 网络，通过广播搜索机制提供通用节点发现能力。所有其他网络都构建在它之上。基网是 P2P 节点的开放“自由市场”——任意应用节点都可以通过它发现同类节点，或定位所需的服务节点。

- **Sub-Networks (子网)**：在基网上自组织形成的专用服务网络。每个子网的节点既会在子网内部互联以进行协同，也会同时为接入的应用节点提供服务。

基网由外部库实现（[cxio/p2p](https://github.com/cxio/p2p)）。Evidcoin 只需定义与该层交互的清晰接口。

### 1.2 Relationship Diagram（关系图）

```graph
    ┌───────────────────────────────────────────┐
    │             Base Network (基网)           │
    │         Node Discovery & Broadcast        │
    └────┬─────────────────┬──────────────┬─────┘
         │                 │              │
         V                 V              V
    ┌────────────┐   ┌────────────┐   ┌──────────┐
    │   Depots   │   │  Blockqs   │   │   STUN   │
    │ (数据驿站) │   │ (区块查询) │   │ (stun2p) │
    └───┬───┬────┘   └──┬───┬─────┘   └───┬──┬───┘
        │   │           │   │             │  │
        │   └───┐       │   └───┐         │  │
        │       │       │       │         │  │
        V       V       V       V         V  V
    ┌────────────────────────────────────────────┐
    │               Blockchain Peers             |
    |                  (应用节点)                │
    └────────────────────────────────────────────┘
```

- 单向箭头表示支持关系（服务提供）。
- 应用节点连接服务节点以获取功能；服务节点彼此互联以进行协同。


## 2. Service Network Descriptions（各服务网络描述）

### 2.1 Data Depots — `depots`（数据驿站）

**用途**：区块链数据的持久化存储与 P2P 文件共享，包括完整区块与交易附件。

**关键特性**：

- 以文件共享网络方式运作，适合大体积数据对象。
- 节点通过 **data signaling** 协调存储决策——在网络中交换数据存在性与稀缺性信息。
- **Scarcity sensing**：当广播一个数据查询时，持有目标数据的节点会响应并停止继续转发；不持有数据的节点会将跳数计数器加一并继续转发。跳数可粗略衡量数据稀缺程度——跳数越高表示越稀缺，从而为存储决策提供依据。
- **Data heartbeat**：公益节点会周期性探测冷数据或低需求数据，以维持其在网络中的可用性。对于区块链附件，链本身提供了确定性的目录，便于系统化探测。
- **Data upload**：当应用节点查询它自己产生的数据时，该查询会触发附近节点的补充存储行为，使产生数据的节点可以作为初始数据源提供内容。

**Query mechanism**：数据发现使用基网的广播搜索机制，并允许各子网按需定制实现。

**Scope boundary**：小于 10 MB 的附件（通常 ≤ 2 MB）或更大附件的分片索引文件也可由 Blockqs 提供；完整区块与 ≥ 10 MB 的附件由 Depots 负责。

**Project**: [github.com/cxio/depots](https://github.com/cxio/depots)

### 2.2 Block Query Service — `blockqs`（区块查询）

**Purpose**：面向区块链交易数据的高性能查询服务，针对小数据请求提供快速响应。

**Supported Query Types**：

| Query Type | Description |
|---|---|
| **Script** | 通用检索交易及其输出 |
| **Script Set** | 获取目标交易的全部输出 |
| **Transaction** | 获取完整交易数据 |
| **UTXO** | 检查目标输出是否已被花费 |
| **UTXO Data** | 获取当前UTXO集数据 |
| **UTCO** | 检查目标凭证输出是否已被使用 |
| **UTCO Data** | 获取当前UTCO集数据 |
| **Transaction ID Set** | 获取与某个账户（地址）相关的交易集合 |
| **Attachment** | 小附件（< 10 MB）或更大附件的分片索引文件 |

**Operational model**：

- Blockqs 节点会连接其所服务的区块链网络，实时接收并存储交易数据。
- 新启动的 Blockqs 节点可从 Depots 引导历史数据。
- 当接受区块链应用节点的连接时，Blockqs 节点会发送自己的区块链地址，以便接收可能的奖励分配。

**Project**: [github.com/cxio/blockqs](https://github.com/cxio/blockqs)

### 2.3 NAT Traversal Service — `stun2p`（NAT服务）

**Purpose**：提供 NAT 探测与打洞的服务网络，使 NAT 后的节点可以建立基于 UDP 的 P2P 连接。

**Features**：

- 对运行在 NAT 受限环境中的节点至关重要。
- 提供 NAT 类型检测并协助打洞。
- 通用型服务——可用于任何 P2P 应用，不限于区块链。

**Project**: [github.com/cxio/stun2p](https://github.com/cxio/stun2p)


## 3. Connection Security（连接安全）

所有 P2P 连接使用自签名证书，并通过 **SPKI fingerprint verification** 进行验证。证书具有合理的有效期（约 **30 days**）。该方式避免依赖证书颁发机构，同时维持对等节点之间的认证与加密连接。

> **注：**
> 节点的 SPKI 指纹会与节点的连系信息（IP、端口等）一并被分享。


## 4. Minting Schedule（铸造时间表）

在固定 **6 minutes** 出块间隔下，系统每年产生 **87,661 blocks per year**（基于 365.25636 天的恒星年）。

### 4.1 Pre-release Phase（预发布阶段） — Years 1–3

为期三年的试运行期，铸币速率逐年提高，以防止早期参与者积累不成比例的持币量：

| Year | Mint Rate (coins/block) | Annual Mint | Cumulative Total |
|------|------------------------|-------------|------------------|
| 1 | 10 | 876,610 | 876,610 |
| 2 | 20 | 1,753,220 | 2,629,830 |
| 3 | 30 | 2,629,830 | 5,259,660 |

### 4.2 Formal Issuance Phase（正式发行阶段） — Starting Year 4

- 从 **40 coins/block** 开始。
- 每 **2 年** 下降 **20%**。
- 计算以整币为单位（不使用 satoshis），避免长时间的微量发行。
- 当速率降至 **3 coins/block** 时结束。

| Years | Mint Rate (coins/block) | Period Mint | Cumulative Total |
|-------|------------------------|-------------|------------------|
| 4–5 | 40 | 7,012,880 | 12,272,540 |
| 6–7 | 32 | 5,610,304 | 17,882,844 |
| 8–9 | 25 | 4,383,050 | 22,265,894 |
| 10–11 | 20 | 3,506,440 | 25,772,334 |
| 12–13 | 16 | 2,805,152 | 28,577,486 |
| 14–15 | 12 | 2,103,864 | 30,681,350 |
| 16–17 | 9 | 1,577,898 | 32,259,248 |
| 18–19 | 7 | 1,227,254 | 33,486,502 |
| 20–21 | 5 | 876,610 | 34,363,112 |
| 22–23 | 4 | 701,288 | 35,064,400 |
| 24–25 | 3 | 525,966 | 35,590,366 |

### 4.3 Long-term Phase（长期阶段）

正式发行结束后，系统维持永久的低通胀率 **3 coins/block**（约 262,983 coins/year）。这保证矿工/铸造者始终拥有与交易手续费无关的基础收入来源。

> **Note**：长期通胀式铸币本质上是一种系统范围的税。在足够低的比例下，这是为维持网络安全而进行的合理折中。


## 5. Deflation Mechanism（通缩机制）

### 5.1 The 50% Fee Burn Rule（50%费用燃烧规则）

交易手续费是交易中输入币值与输出币值之差。Evidcoin 对所有交易手续费施行 **50% burn**：

- 每个区块的交易手续费总额中，仅 **50%** 记入 Coinbase 输出。
- 其余 **50%** 永久销毁（burn）。
- 被销毁部分可计算验证——不会以 UTXO 形式存储或记录。校验者只需确认 Coinbase 收入满足：`minting_reward + 50% × total_fees + reclaimed_unclaimed_rewards`。

### 5.2 Dynamic Equilibrium（动态平衡）

这形成一个自我调节的反馈环：

1. **When transaction volume is high** → 燃烧更多手续费 → 总供给下降 → 币值上升 → 交易更昂贵 → 活动回落。
2. **When transaction volume is low** → 燃烧更少手续费 → 铸币带来供给增长 → 币值下降 → 交易更便宜 → 活动上升。

该机制与永久 3 coins/block 的铸币相结合，形成倾向于长期价值稳定的 **dynamic inflation-deflation market**。

### 5.3 Worked Example（计算示例）

假设某区块包含 50,000 笔交易，平均手续费为 0.00012 bi：

```
Total fees:        50,000 × 0.00012 = 6 bi
Burned (50%):      3 bi
Retained fees:     3 bi
Minting reward:    3 bi
Block revenue:     3 + 3 = 6 bi
Net supply change: +3 (minted) − 3 (burned) = 0 (equilibrium)
```


## 6. Revenue Distribution（收入分配）

### 6.1 Coinbase Transaction Structure（铸币交易结构）

Coinbase 交易是每个区块中的特殊交易，用于封装该区块的全部收入。其总收入由以下部分构成：

```
Total Revenue = Minting Reward
              + Retained Transaction Fees (50% of total fees)
              + Reclaimed Unclaimed Rewards (from blocks that failed redemption)
```

### 6.2 Distribution Ratios（分配比例）

总收入在五类接收者之间分配：

| Recipient | Share | Description |
|-----------|-------|-------------|
| **Validators (校验组)** | 40% | 负责校验并铸造该区块的团队 |
| **Evidence Minter (铸凭者)** | 10% | 提供铸造凭证交易的参与者 |
| **Depots** | 20% | 数据存储与文件共享服务 |
| **Blockqs** | 20% | 区块查询与交易检索服务 |
| **STUN** | 10% | NAT 穿透服务 |

> **Note**：分配使用整数运算。由舍入产生的任何余数保留给分配序列中的最后一名接收者。

### 6.3 Coinbase Outputs（Coinbase 输出项）

Coinbase 交易包含对应各类别接收者的输出：

1. **Validator output** — 支付给铸造团队地址（40%）。
2. **Evidence Minter output** — 支付给凭证交易提供者（10%）。
3. **Depots reward output** — 支付给选定的 Depots 节点地址（20%）。
4. **Blockqs reward output** — 支付给选定的 Blockqs 节点地址（20%）。
5. **STUN reward output** — 支付给选定的 STUN 节点地址（10%）。

服务节点在接受应用节点的连接时会出示其区块链地址，使铸造者能够识别可获得奖励的服务接收方。


## 7. Reward Redemption Mechanism（奖励兑换机制）

### 7.1 Design Rationale（设计原理）

区块铸造者可以自由指定三类公共服务奖励的接收者——甚至可以指定并未实际提供服务的节点。奖励发放时链上不会强制校验服务质量。

但奖励的 **兑换（redemption）** 需要后续铸造者的确认，从而形成间接的质量过滤机制。

### 7.2 Confirmation Rules（确认规则）

在奖励发放后的 **48 blocks**（约 4.8 小时）内，至少需要 **2** 名后续铸造者确认，方可全额兑换：

| Confirmations | Portion Released | Cumulative Redeemable |
|---------------|------------------|-----------------------|
| 1 | 50% | 50% |
| 2 | 50% | 100% |

- 每个后续铸造者在其 Coinbase 交易中携带一个 **confirmation slot**（兑奖槽）：一个 144 位（18 字节）的位图，覆盖 3 类服务 × 48 个区块。
- 铸造者会评估 144 个待确认奖励；若认为目标服务节点表现合格，则置位对应 bit。
- 若某奖励在 48 个区块内未获得 2 次确认，则未被领取的部分会在第 49 个区块的 Coinbase 中作为额外收入被 **reclaimed**。

### 7.3 Early Redemption（提前兑现）

若某奖励在 48 区块窗口结束前已获得 2 次确认，则在 **25 blocks** 后（分叉风险已消除）即可兑换。

> **注：**
> 此规则由锁定脚本中的 `SYS_AWARD` 指令实现。

### 7.4 Evaluation Methods（评估方法）

各服务类型有相对可行的评估方式：

| Service | Evaluation Method |
|---------|-------------------|
| **STUN** | 向已连接的 stun2p 节点请求 NAT 探测与打洞；按连通性、准确性与响应时间评估 |
| **Depots** | 请求随机的链上区块、交易或附件（或大文件的单个分片）；按数据完整性与响应质量评估 |
| **Blockqs** | 校验组与 Blockqs 节点保持紧密连接；按常规可达性与性能评估 |

### 7.5 Cache Pool for Evaluation（评估缓存池）

校验组维护一份服务表现良好的服务节点缓存。后续区块在确认奖励时会参考该缓存。

对于约 10,000 节点规模的服务网络：

- **valuators per cycle**：48 / 2 = 24 个区块可为每笔奖励贡献确认。
- **Required cache size**：~10,000 / 24 ≈ 416 个服务地址。

实际中由于重叠，所需缓存会更小。缓存规模会随网络规模增长——网络越大，单节点命中率越低，可能需要相应调参。


## 8. Long-term Sustainability Analysis（长期可持续性分析）

### 8.1 Revenue Guarantee（收益保障）

永久的 3 coins/block 铸币保证即便交易手续费为零，公共服务节点仍能获得非零奖励：

```
Per block (zero-fee scenario):
  Total revenue:     3 coins
  Depots:            3 × 20% = 0.6 coins
  Blockqs:           3 × 20% = 0.6 coins
  STUN:              3 × 10% = 0.3 coins
```

该基线可避免“空区块”问题：即服务节点因缺乏收益而没有运行动力。

### 8.2 Incentive Alignment（激励对齐）

系统在参与者之间对齐激励：

- **Minters** 受益于健康的服务网络——没有 Blockqs 与 Depots，普通节点难以高效参与，交易量与手续费收入会下降。
- **Service nodes** 通过与服务质量正相关的区块奖励获得激励（由兑换机制进行过滤）。
- **Users** 受益于更低的硬件要求，并可通过专用服务节点更便捷地访问链上数据。

### 8.3 The "Stingy Blockchain" Consideration（吝啬的区块链）

从整个第三方服务网络的生态来说，让区块链对服务节点进行奖励的机制无法强制，也即一条区块链可能不奖励任何服务，但却从服务网络索取服务。这种“吝啬区块链”策略实际上存在风险：

- 区块链的价值来自外部用户的信任与采用。
- 忽视服务基础设施的“吝啬区块链”会失去竞争力。或者，没有哪个服务节点愿意为其提供服务。
- 由于 Evidcoin 是开源的，竞争链可以采用相同技术并提供更公平的激励分配。
- 将区块收入分配给外部服务不是损失——而是对生态的投资，而生态正是创造该收入现实价值的来源。

### 8.4 Generality of Services（服务通用性）

由于节点发现与数据存储是 P2P 应用的共性需求，Depots 与 STUN 节点也可以选择性地为非区块链 P2P 应用提供服务，从而形成更广泛的 P2P 生态：

- 服务节点可将“客户基础”从单纯的区块链扩展到更多种类的应用。
- 非区块链应用可复用既有基础设施。
- 生态通过多样化而更具韧性。

### 8.5 Security Considerations（安全性考虑）

对公共服务节点的评估是局部的，局部评估模型承认：没有任何单一铸造者能获得所有服务节点的全局视角。这也形成了一种客观的折中：

- 把奖励发给不存在或不可用的服务节点没有意义——后续铸造者不会确认它。
- 给自己的服务节点自我派奖是可接受的——该节点仍需提供可验证的服务。
- 较低的确认门槛（48 个区块中 2 次确认）适配 P2P 网络固有的局部可见性。
- 48 区块窗口（约 4.8 小时）为确认提供充足时间，同时避免未领取资金被无限期锁定。
