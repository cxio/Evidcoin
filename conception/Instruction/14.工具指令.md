# 工具指令

包含一些基础并常用的功能性指令。另外还有一个保留区（量子安全）。


## 定义

指令码区间：`[138-163]`，26个。

```go
码值    指令字      说明
-----------------------------------------------------------
138     EVAL        执行脚本
        // 将实参视为脚本指令序列执行。
        // 拥有独立的执行域（环境），与外部隔绝，
        // 但内部数据栈的遗留项会作为一个切片返回到调用层。
        // 实参：Script。
        // 返回值：一个切片。
        // 注意：
        // 实参是有类型的，仅能由 CODE、SCRIPT 创建。
        //
        // 安全性：
        // 该指令通常不应当用于公共验证，
        // 主要用于封闭的私域环境，其可自行负责安全。
        // 也即：脚本内的通关状态与调用层无关。
        //
        // 设计：
        // EVAL指令仅能通过内部数据栈存留与上层调用者交互。
        // 且数据栈存留项以普通条目性质返回。

139     COPY        复制（切片）
        // 将切片成员复制到一个新的空间。这是一个浅复制。
        // 实参：一个切片。
        // 返回值：一个包含成员副本的新切片。
        // 提示：
        // 如果需要切片成员的递归式深复制，可用 DCOPY。

140     DCOPY       深层复制（切片）
        // 切片成员递归式深复制到一个新的空间。
        // 实参：一个切片。
        // 返回值：一个全新的切片。
        // 注：
        // 子切片会递归复制，直到成员为非切片类型，any成员也会递进检查。

141     KEYVAL(1)   字典键值切取
        // 附参：切取类型。
        // - 0: 键和值。两个切片。
        // - 1: 仅键。一个切片。
        // - 2: 仅值。一个切片。
        // 实参：一个字典。
        // 返回值：1~2个切片。
        // 返回两个切片时，两者的成员会一一对应。
        // 两个结果会自动展开到接收域。
        // 例：
        // @KEYVAL  键值两个切片展开到实参区。此时实参区有两个切片

142     MATCH(1)    正则匹配
        // 对字符串或字节序列进行正则匹配，取匹配值或子匹配的值。
        // 附参：匹配方式（g|G|o|s|_）。
        // 实参1：目标字符串或字节序列。
        // 实参2：正则表达式（*RegExp）。
        // 返回值：布尔值|单值|切片。
        // 附参值：
        // _：零值，匹配测试（re.Match），返回Bool。
        // g：查找所有，但仅限于完整匹配（re.FindAll）。
        // G：查找所有，包括捕获组（re.FindAllSubmatch）。
        // o：查找首个匹配（re.Find），返回单值
        // s：查找首个匹配，包括捕获组（re.FindSubmatch）。
        // 注意：
        // 如果正则式不含子匹配式，想要获取全部匹配应当使用 g 标记，
        // 因为 G 标记确定会返回一个二维切片。
        // 例：
        // /(?i)[a-z]+/ MATCH{g}        获取全部完整匹配，结果是一个切片
        // /(?i)[a-z]+/ MATCH[103]      同上，用 g 的码值表示
        // /(?i)Ver-(\d+)/ MATCH{G}     获取全部匹配，包含子匹配，结果是一个二维切片
        // /(?i)Ver-(\d+)/ MATCH{s}     获取首个匹配。返回的切片包含了两个成员
        // /(?i)[a-z]+/ MATCH{o}        获取首个匹配。返回一个单值
        // /(?i)\b[0-9a-f]+\b/ MATCH    是否包含一个十六进制数，默认0值省略

143     SUBSTR(~)   字串截取
        // 附参：符文（Rune）数量。
        // 实参1：一个字符串（UTF-8）。
        // 实参2：起始字符位置。按字符计数，从0开始。支持负数从末尾算起。
        // 返回值：一个子字符串。
        // 注意：
        // 目标字符串应当是合法的UTF-8编码序列。
        // 如果截取的子字符串长度不足，返回一个空串（出错）。
        //
        // 设计：
        // 作为栈脚本，使用静态的附参定义字符数量可能更安全，
        // 比如用户可以明确地检查是否为出错。

144     REPLACE(1)  字串替换
        // 对目标字符串中匹配的部分进行替换。
        // 附参：替换次数，0值表示全部。
        // 实参1：目标字符串。
        // 实参2：替换匹配式（子串或正则表达式）。
        // 实参3：替换串，可包含特殊标识（当匹配式为正则表达式时）。
        // 返回值：一个新的字符串。
        // 说明：
        // 仅支持字符串目标。
        // 匹配式为正则表达式时会替换全部，不能指定次数。

145     RANDOM      创建一个随机数
        // 返回的随机数是安全的（crypto/rand）。
        // 实参：上限边界，可选。
        // 返回值：一个小于实参的非负随机数，类型与实参同。
        // 注意：
        // 上限可选，Int|BigInt类型，如果提供则需大于零。
        // 默认int64类型，上限为其可表达的最大值。

146     QRAND       创建一个随机数（快速）
        // 快速获取一个随机数（不安全）。
        // 实参：上限值，可选。Int类型。
        // 返回值：一个小于实参的非负随机数。
        // 注意：
        // 上限值可选，默认为int64可表达的最大值。不能为负。
        // 应当仅用于要求效率而非安全的场合。

147     SLRAND      成员顺序打乱（切片）
        // 实参：一个切片。
        // 返回值：成员顺序随机重排的一个新切片。
        // 注意：
        // 随机数的种子是安全的，但不保证随机性的安全。

148     CMPFLO(1)   浮点数比较
        // 附参：比较类型标识。
        // > 0  相等比较（==）
        // > -1 小于等于（<=）
        // > 1  大于等于（>=）
        // 实参1：待比较值。
        // 实参2：待比较值。
        // 实参3：误差值，实参1-2间的差值不超过该值时即视为相等。
        // 返回值：一个布尔值。
        //
        // 设计：
        // 主要用于弥补比较指令中对浮点数相等测试的不足。
        // 如果只是不涉及相等的大于或小于对比，请用比较指令。

149-150 （未用）

151     RANGE(1)    创建数值序列
        // 附参：序列长度（成员数量）。
        // 实参1：起始值，Int|Float。
        // 实参2：步进值，Int|Float。
        // 返回值：一个数值切片。
        // 说明：
        // 返回数值类型由实参表达，以实参1为基准。
        // 附参0值会创建一个空切片，此时的实参1仅表达类型。
        // 例：
        // {10} {1} RANGE[5]    // [10, 11, 12, 13, 14]
        // {1.} {1.1} RANGE[5]  // [1.0, 2.1, 3.2, 4.3, 5.4]
        //
        // 设计：
        // 附参仅由1字节表达，因此仅用于创建小数值序列。
        // 这是基于性能和安全性的考虑。
        // 如果需要较大的集合，可以考虑合并多个结果（MERGE）。
        // 例：
        // {0, 250, 500, 750}
        // EACH{
        //      $Value {1} RANGE[250]
        // }
        // @POPS[4] MERGE   // [0, 1, 2, ...999]

152     MAP{}(~)    映射迭代
        // 针对目标集，迭代每一个成员执行子语句块，
        // 返回值构造为一个最终切片。
        // 附参：子语句块长度。
        // 实参：不定数量。
        // 首个成员为目标集，后续作为私有数据栈初始成员。
        // 返回值：一个切片。
        // 语法：
        // 内部语句块视为一个独立的脚本域，拥有自己的私有数据栈和实参区。
        // 各个迭代之间共享数据栈和实参区。
        // 局部变量：
        // - $Value         // 当前条目数据
        // - $Index|$Key    // 当前循环键（整数下标或字符串）
        // - $Slice|$Dict   // 迭代集本身
        // - $Size          // 集合大小（迭代次数）
        // 注意：
        // 返回的 nil 值会被忽略，这让指令也有了筛选的能力。
        // 目标集可以是切片或字典，如果是后者，迭代的顺序不确定。
        // 例：
        // @{1, 2, 3, 4}    // 目标集
        // @{20}            // 私有数据栈初始成员
        // MAP{
        //      @( $Value * TOP ) RETURN
        //      // TOP无前置@，这是表达式内的规则
        // }
        // 返回集：[20, 40, 60, 80]

153     FILTER{}(~)   成员过滤
        // 针对目标集，迭代每一个成员执行子语句块
        // 返回真时该成员被选取（不影响原集合）。
        // 附参：子语句块长度。
        // 实参：不定数量。
        // 首个成员为目标集，后续作为私有数据栈初始成员。
        // 返回值：一个切片或字典。
        // 语法：
        // 同上MAP指令。
        // 说明：
        // 支持字典的过滤，返回真的条目构建为一个新的字典。
        // 返回值类型同目标集，切片=>切片，字典=>字典。
        // 例：
        // @{1, 2, 3, 4, 7}     // 目标集
        // @FILTER{
        //      ( $Value % 2 )  // 奇数值为1
        //      @BOOL RETURN    // 转为布尔值返回
        // }
        // PRINT    // 打印 [1, 3, 7]

154     EGO{}(~)    嵌入扩展（Go 语言）
        // 嵌入原生Go代码。
        // 子块内容视为字节数据（类似于值指令）。
        // 附参：内容长度。
        // 返回值：无。
        // 说明：
        // 应当只在存证的识别脚本中有效。
        // 可以在币金或凭信的脚本中出现，但会被校验节点忽略。
        // 参考：
        // 如果出现在锁定脚本中，通常是为了某种传递（OUTPUT）。
        // 代码可由解释器（如 Yaegi）在必要时执行。

155     SHELL{}(~)  嵌入扩展（Shell 脚本）
        // 不限定语言，首行标记解释器（Shebang）即可。
        // 附参：内容长度。
        // 返回值：无。
        // 注意事项同上 EGO 指令说明。
```


## 保留区

主要用于未来可能需要的基础性安全支持，比如抗量子能力。共计 8 个。

```go
156-163 （未用）
```
