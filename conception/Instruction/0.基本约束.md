# 脚本指令集-基本约束

脚本在执行过程中是只读的，脚本的指令不可被修改！
因此对于部分有赋值操作的指令，可能需要在一个副本上操作，以防改变原始脚本内容。


## 概念澄清

- **数据栈**：存放脚本执行过程中产生的各种数据值的栈结构。
- **实参区**：用于存放指令调用时的实参值的区域，类似函数调用的参数传递。
- **局部域**：当前语法块的静态堆叠空间，用于存放局部变量或中间结果。
- **全局域**：整个脚本执行环境的共享空间，用于存放全局变量或状态信息。
- **指令码**：每条指令的唯一标识符，占用1字节。
- **附参**：指令的硬参数（编译时固化），通常用于指定指令本身的属性。
- **关联数据**：指令携带的额外数据，在指令说明中简称**数据**。通常属于较大的数据块，如字符串或代码块。
- **实参**：指令调用时需要传入的运行时参数，可能在实参区，也可能直接从数据栈中获取。


## 指令的结构

每个指令都由 `指令码+附参+关联数据` 构成，其中除了指令码是必需的，其它都视指令不同而可选。

实参是由指令提取出来的值，是指令调用时的参数，不属于指令结构本身。


## 指令说明的格式

指令的说明被放在一个代码块内（go），但并非Go代码。而是为了高亮友好展示，便于阅读。

参考示例：

```go
码值    指令字      说明
-----------------------------------------------------------
0       NIL         空：nil
        // 通用的nil项，表示无值。
        // 指令码值本身表达该值。

11      DATA{}(1)   小数据：[]byte [0, 256)
        // 类型：Bytes
        // 附参：1字节，指定后续数据的长度（uint8）。
        // 数据：字节切片，长度由附参指定。
        // 例：
        // DATA{414243} 内容为 "ABC"，3字节16进制表示。
        //
        // 提示：
        // `DATA{414243}` 编译后的值序列为：
        // 0x0B 0x03 0x41 0x42 0x43
        // 其中：
        // - 0x0B 表示小数据类型指令码，
        // - 0x03 附参，表示数据长度为3，
        // - 后续的 41、42、43 为实际数据内容。

17      CODE{}(~)   代码/指令序列
        // 类型：Script
        // 附参：变长整数，指定后续代码块的字节长度（varint）。
        // 数据：指令序列，包含在 {} 内，长度由附参指定。
        // 例：
        // CODE{
        //      TOP FN_HASH256 DATA{<hashResult>} EQUAL PASS
        // }
        // 花括号内为正常的指令序列（书写格式）。
        //
        // 提示：
        // 这一段指令码编译后的值序列为：
        // - 首字节：0x11 表示 CODE 的指令码，
        // - 紧接着的字节：附参，一变长整数，指定了后续代码块的长度，
        // - 后续的字节：实际的指令序列内容。

52      GOTO(~,64,~)    跳转（独立）
        // 附参1：交易年度（按交易时间戳计算）。
        // 附参2：交易ID。
        // 附参3：输出项序位。
        // 例：
        // GOTO[2026, 0xabcdef..., 1]
        // 引用2026年度，ID为 0xabcdef... 的交易的第1个输出项的脚本。
        // 该脚本将在一个独立子环境中执行（继承部分调用环境）。
        //
        // 提示：
        // 无关联数据，因此指令码后无 {} 花括号跟随。
        // 多个附参依次列出，用逗号分隔。
```

每条指令的说明包含以下部分：

- **指令码**：固定占用1字节，唯一标识该指令。
- **附参**：可选。由小括号（`(1)`）和其中的数字表达，数字表示附参所占字节数。指令可以有多个附参，逗号分隔依次列出。
- **关联数据**：简称「数据」，可选。若指令有此数据，会在说明栏说明。携带数据的指令会跟随一对花括号（`{}`），表示有内容。
- **实参**：可选。指令无实参时则无需说明。
- **说明**：指令的详细说明被放在代码块指令行的下面（悬挂缩进），以注释形式（`//` 开头）书写。

> **提示：**
> 固定长度的附参用数字表达，变长整数时用波浪号（`~`）表示。

